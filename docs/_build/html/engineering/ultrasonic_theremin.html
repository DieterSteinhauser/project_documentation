<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ultrasonic Theremin - Junior Design &mdash; Project Documentation 1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Condenser Microphone Workshop" href="condenser_microphone.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Project Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../rpi/rpi_projects.html">Raspberry Pi Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programming/programming_projects.html">Programming Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fun/fun_projects.html">Entertainment Projects</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="engineering_projects.html">Engineering Projects</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="condenser_microphone.html">Condenser Microphone Workshop</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Ultrasonic Theremin - Junior Design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#methods">Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#project-overview">Project Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pico-overview">Pico Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adc-theory">ADC Theory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adc-configuration">ADC Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spi-theory">SPI Theory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dac-theory">DAC Theory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dac-configuration">DAC Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#operational-amplifier-theory">Operational Amplifier Theory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#first-order-filter-theory">First-Order Filter Theory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#audio-amplifier-configuration">Audio Amplifier Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#power-regulation-and-filtering">Power Regulation and Filtering</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inputs-and-outputs">Inputs and Outputs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ultrasonic-sensors">Ultrasonic Sensors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lcd-configuration">LCD Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#theremin-circuit-configuration">Theremin Circuit Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#schematic-and-pcb-design">Schematic and PCB Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bill-of-materials">Bill Of Materials</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#results">Results</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#power">Power</a></li>
<li class="toctree-l4"><a class="reference internal" href="#audio">Audio</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interface-and-display">Interface and Display</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#discussion">Discussion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#appendix">Appendix</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#lcd-py">LCD.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lut-py">LUT.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spi-config-py">spi_config.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#theremin-py">theremin.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Project Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="engineering_projects.html">Engineering Projects</a> &raquo;</li>
      <li>Ultrasonic Theremin - Junior Design</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/engineering/ultrasonic_theremin.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ultrasonic-theremin-junior-design">
<h1>Ultrasonic Theremin - Junior Design<a class="headerlink" href="#ultrasonic-theremin-junior-design" title="Permalink to this headline"></a></h1>
<p>Date: 11/2022</p>
<figure class="align-center" id="id65">
<img alt="../_images/image054.jpg" src="../_images/image054.jpg" />
<figcaption>
<p><span class="caption-text">Figure 42: Ultrasonic Theremin in its case.</span><a class="headerlink" href="#id65" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline"></a></h2>
<p>The Theremin is a musical instrument designed by Leon Theremin in 1928. The device
operates using two antennas relying on capacitor physics, which sense the position of the
operator’s hands. One antenna influences the output frequency of the note, while the other
influences the volume of the note. While the original theremin operates on a series of analog
systems, I intend to implement similar systems in the digital domain by using the ultrasonic
sensors to determine distance between the instrument and the operator’s hands. The digital and
analog inputs will augment a waveform generator, which creates an audio signal according to the
user’s movements, creating a digital instrument.</p>
</section>
<section id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this headline"></a></h2>
<section id="project-overview">
<h3>Project Overview<a class="headerlink" href="#project-overview" title="Permalink to this headline"></a></h3>
<p>The raspberry Pico interfaces with multiple components and generates waveform
functions for audio output. Ultrasonic sensors detect distance from the users’ hands for frequency
determination. Status of the device is displayed on an LCD. Switches and Buttons are available
on the device for interaction, selecting output waveforms and other menu options. Potentiometers
are connected to the Pico ADC for controlling the upper and lower boundaries of the frequency
range. LED’s will assist by lighting up when a boundary is hit.</p>
<p>All generated waveforms are sent to the DAC via SPI and then to the LM386 audio
amplifier, which drives the 8-ohm speaker. Everything can be powered using a 9V battery or
adapter, as 5V is generated using the LM2940 LDO. This powers most standalone components,
including the Pico. The SMPS on the Pico also generates 3.3V and is filtered for usage in GPIO.</p>
</section>
<section id="pico-overview">
<h3>Pico Overview<a class="headerlink" href="#pico-overview" title="Permalink to this headline"></a></h3>
<p>The Raspberry Pico is a development board with an RP2040 microcontroller chip. It has
264KB of SRAM and 2MB of flash memory. Development for the Pico is versatile as the
platform capable of being programmed in MicroPython, CPython, C, and Rust <a class="footnote-reference brackets" href="#id59" id="id1">15</a>. The Pico has
a dual core processor capable of 133MHz clock speed, set to 125MHz out of the box. There are
40 GPIO pins on the board, with SPI, I2C, and UART communication capability. The Pico
comes equip with a 12-bit 500ksps ADC with 5 channels total. One channel is configured to an
RP2040 internal temperature sensor, and three are tied to GPIO pins on the Pico <a class="footnote-reference brackets" href="#id60" id="id2">16</a>. The Pico
also has a timer with four alarms, a Real-Time-Counter (RTC), and sixteen Pulse-Width Modulation (PWM) channels</p>
<figure class="align-center" id="id66">
<img alt="../_images/image0011.png" src="../_images/image0011.png" />
<figcaption>
<p><span class="caption-text">Figure 1: Raspberry Pico Pinout <a class="footnote-reference brackets" href="#id59" id="id3">15</a>.</span><a class="headerlink" href="#id66" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="adc-theory">
<h3>ADC Theory<a class="headerlink" href="#adc-theory" title="Permalink to this headline"></a></h3>
<p>Analog to Digital Converters are the primary method of capturing analog data using a
microcontroller. ADC’s capture analog signals such as sound or light waveforms and convert
them to a digital signal for processing of information. An ADC takes continuous magnitude data
from a continuous time domain into discrete magnitude data in a discrete time domain <a class="footnote-reference brackets" href="#id47" id="id4">3</a>. The
conversion quantizes the signal based on the resolution, reference voltages, and sample rate of
the ADC, introducing small errors into the signal as noise.</p>
<figure class="align-center" id="id67">
<img alt="../_images/image0021.png" src="../_images/image0021.png" />
<figcaption>
<p><span class="caption-text">Figure 2: Quantization of an Analog to Digital Converter on a sine wave.</span><a class="headerlink" href="#id67" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Resolution and reference voltages of an ADC produces quantization errors within the
amplitude domain of a signal, where the sample rate of an ADC produces quantization errors
within the time domain. Resolution gives the number of discrete values an ADC can produce,
where the reference voltages provide the span of voltages the ADC can receive as a signal.
Ground is often defaulted to the lower reference voltage to simplify ADC implementation. As a
result, the voltage resolution in volts per bit is given as the span between the reference voltages
divided by the number of discrete values the ADC resolution can produce. The digital code made
by the ADC multiplied by the voltage resolution of the ADC will return the voltage recorded by
the ADC. Quantization produces rounding errors in the approximation of the analog voltage,
which is worsened by noise and jitter that exists on the signal prior to the ADC conversion.
Signal noise can significantly reduce the effective number of bits to which an ADC is accurate.</p>
<figure class="align-center" id="id68">
<a class="reference internal image-reference" href="../_images/image0031.png"><img alt="../_images/image0031.png" src="../_images/image0031.png" style="width: 400px;" /></a>
<figcaption>
<p><span class="caption-text">Figure 3: ADC formulas.</span><a class="headerlink" href="#id68" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Sample rate of an ADC produces quantization errors within the time domain of the
signal. The sampling rate of an ADC should ideally greater than twice the highest frequency
being recorded, otherwise aliasing will occur. Aliasing can also be mitigated by adding a low-pass
filter to the ADC input, removing frequencies above half of the sampling frequency.
Oversampling is also commonly employed as it can reduce noise and improve bit-depth.</p>
</section>
<section id="adc-configuration">
<h3>ADC Configuration<a class="headerlink" href="#adc-configuration" title="Permalink to this headline"></a></h3>
<p>Since the ADC in on the Raspberry Pico, initial setup of the ADC can easily be achieved
using the ADC section of the Pico Software Development Kit (SDK) <a class="footnote-reference brackets" href="#id60" id="id5">16</a>. This provides the
engineer with a simple and straightforward introduction on taking ADC readings. However, the
12-bit ADC onboard the Pico is not great by any means. This is due to the switching power
regulator on the Pico. As a result of switching signal noise, the onboard voltage reference for the
ADC is setup in poor conditions. The ADC has a 30mV offset and its signal is quite noisy <a class="footnote-reference brackets" href="#id59" id="id6">15</a>.
The datasheet gives suggestions on improvement of the ADC readings. An External reference
voltage may be used, the R7 resistor can be removed, or issues can be mitigated in averaging and
offset code. I chose a different route entirely, by adding bypass capacitors to the reference
voltage and ADC input pins for filtering and smoothing. This is enough for the applications of
this project.</p>
</section>
<section id="spi-theory">
<h3>SPI Theory<a class="headerlink" href="#spi-theory" title="Permalink to this headline"></a></h3>
<p>SPI is a full-duplex serial communication protocol that was created by Motorola in the
1980’s for high-speed communication in embedded systems <a class="footnote-reference brackets" href="#id62" id="id7">18</a>. The SPI protocol consists of a
single master device and one or many slave devices. For a simple two device system, A clock
(SCLK), a chip select (CS), and two data lines (MOSI, MISO) are employed. MOSI is the data
transmitted from the master device, while MISO is the data received from the master device.</p>
<figure class="align-center" id="id69">
<img alt="../_images/image0041.png" src="../_images/image0041.png" />
<figcaption>
<p><span class="caption-text">Figure 4: SPI configuration for a two-device system <a class="footnote-reference brackets" href="#id49" id="id8">5</a>.</span><a class="headerlink" href="#id69" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>SPI can incorporate multiple slave devices by connecting data and clock lines,
individually accessing a slave device by using a dedicated chip select line for each device as seen
in figure 5. This can become GPIO intensive as the number of pins needed on the master device
will increase with each additional slave device. Alternatively, SPI devices can work
cooperatively by tying all chip selects to the same line as seen in figure 6. This works well if data
does not need to be returned from the slave devices and the slave devices are intended to have
the same output.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="../_images/image0051.png"><img alt="fig5" src="../_images/image0051.png" style="width: 320px;" /></a></p></td>
<td><p><a class="reference internal" href="../_images/image0061.png"><img alt="fig6" src="../_images/image0061.png" style="width: 320px;" /></a></p></td>
</tr>
<tr class="row-even"><td><p><em>Figure 5: SPI independent configuration</em> <a class="footnote-reference brackets" href="#id49" id="id9">5</a>.</p></td>
<td><p><em>Figure 6: SPI daisy-chained configuration</em> <a class="footnote-reference brackets" href="#id49" id="id10">5</a>.</p></td>
</tr>
</tbody>
</table>
<p>SPI transmits and receives data simultaneously in both directions, making the
communication full duplex in design. SPI also uses GPIO for addressing a chip instead of
transmitting addresses over the data lines commonly seen in I2C. Because of the full duplex data
transmission and GPIO addressing, SPI has very high transmission speeds, but can become
GPIO intensive. In practice, the maximum clock speeds of a SPI configuration depend highly on
the connected devices and their method of connection. Finally, the SPI protocol is highly
configurable in that the clock polarity and phase can be configured. This is also highly dependent
on connected devices and should be considered when creating a two-device or multi-device
system. In terms of using SPI on the Pico, A clock at or below 1MHz is best for breadboarding
and flywire use.</p>
</section>
<section id="dac-theory">
<h3>DAC Theory<a class="headerlink" href="#dac-theory" title="Permalink to this headline"></a></h3>
<p>A Digital to Analog Converter operates on much of the same principles of an ADC but in
reverse. DAC’s take a digital code that is within the resolution range of the device and output an
analog waveform. Uses for DAC’s are often found in creating audio and video signals <a class="footnote-reference brackets" href="#id49" id="id11">5</a>. A
DAC will have a singular or pair of voltage references and a bit resolution for characterizing the
precision and range of the output waveform. An output voltage can be calculated by dividing a
given code by the number of discrete values the DAC can produce. This is then multiplied by the
reference voltage to return the ideal output voltage.</p>
<figure class="align-center" id="id70">
<a class="reference internal image-reference" href="../_images/image0071.png"><img alt="../_images/image0071.png" src="../_images/image0071.png" style="width: 400px;" /></a>
<figcaption>
<p><span class="caption-text">Figure 7: DAC formulas.</span><a class="headerlink" href="#id70" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>DAC’s have some non-idealities in the form of differential and integral non-linearity,
which characterize the difference between two adjacent code values and the difference in the
transfer characteristic, respectively.</p>
</section>
<section id="dac-configuration">
<h3>DAC Configuration<a class="headerlink" href="#dac-configuration" title="Permalink to this headline"></a></h3>
<p>The LTC1661 from Linear Technology hosts two 10-bit DAC’s that are addressable via
SPI <a class="footnote-reference brackets" href="#id47" id="id12">3</a>. Communication is configured with the SPI clock idling low and capturing data on the
rising edge of the clock. Simple initialization of SPI on the Pico can be seen chapter 3.7 the
MicroPython SDK <a class="footnote-reference brackets" href="#id60" id="id13">16</a>. For an in-depth approach to SPI initialization and communication on the
Pico, the MicroPython documentation for the SPI module proved insightful <a class="footnote-reference brackets" href="#id58" id="id14">14</a>. The maximum
baud rate of the LTC1661 is 10MHz <a class="footnote-reference brackets" href="#id56" id="id15">12</a>. I employed a baud rate of no larger than 8MHz to
avoid data corruption on the breadboard. However, small distances of SPI connections on the
final PCB make higher speeds possible. The default SPI pins of the Pico were employed, located
the bottom right corner of the Pico Pinout <a class="footnote-reference brackets" href="#id59" id="id16">15</a>.</p>
<figure class="align-center" id="id71">
<img alt="../_images/image008.png" src="../_images/image008.png" />
<figcaption>
<p><span class="caption-text">Figure 8: Timing Diagram of LTC1661 SPI communication <a class="footnote-reference brackets" href="#id56" id="id17">12</a></span><a class="headerlink" href="#id71" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Communication with this DAC is slightly more complicated due to the 10-bit resolution
associated with the device. Commanding the device to write to its internal register and Update is
the primary functionality desired for this module. Knowing this, the commands 0x9 or 0xA
would be applicable for continuously changing voltage on output A and B respectively <a class="footnote-reference brackets" href="#id56" id="id18">12</a></p>
<figure class="align-center" id="id72">
<img alt="../_images/image009.png" src="../_images/image009.png" />
<figcaption>
<p><span class="caption-text">Figure 9: SPI communication Sequence for the LTC1661 <a class="footnote-reference brackets" href="#id56" id="id19">12</a>.</span><a class="headerlink" href="#id72" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>In our program, we must parse the data for every transmission so that a word packet sent will
have the format seen in figure 9. The LTC1661 sends the command, then splits the data bits
between the two bytes, followed by don’t cares to fill the word packet. In an 8-, 12-, or 16-bit
DAC, less bit manipulation is required.</p>
</section>
<section id="operational-amplifier-theory">
<h3>Operational Amplifier Theory<a class="headerlink" href="#operational-amplifier-theory" title="Permalink to this headline"></a></h3>
<p>Operational Amplifiers (Op-Amps) are high-gain voltage amplifiers with differential
input and a single voltage output. Op-Amps typically have five terminals: An inverting input,
non-inverting input, an upper supply, a lower supply, and an output. An ideal Op-Amp has an
infinite input resistance and zero output resistance. As a result, input terminals see zero current.
Input terminals also see equivalent voltages. Lastly, ideal op-amps experience infinite open-loop
gain and infinite Gain Bandwidth (GBW).</p>
<figure class="align-center" id="id73">
<img alt="../_images/figure10.png" src="../_images/figure10.png" />
<figcaption>
<p><span class="caption-text">Figure 10: Anatomy of an Op-Amp and Ideal Op-Amp Equations <a class="footnote-reference brackets" href="#id45" id="id20">1</a>.</span><a class="headerlink" href="#id73" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Using an infinite open-loop gain is limiting, as the output voltage signal would become
saturated immediately. This could be useful in a comparator circuit. However, for most purposes
some form of negative feedback is implemented to create a closed loop gain within the
boundaries of the supply rails. Negative feedback amplifiers come in inverting (Figure 11) and
non-inverting (Figure 12) configurations, with gain determined by the ratio of resistances seen by
the negative feedback loop.</p>
<figure class="align-center" id="id74">
<img alt="../_images/figure11.png" src="../_images/figure11.png" />
<figcaption>
<p><span class="caption-text">Figure 11: Inverting Op-Amp configuration and voltage gain equation <a class="footnote-reference brackets" href="#id45" id="id21">1</a>.</span><a class="headerlink" href="#id74" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id75">
<img alt="../_images/figure12.png" src="../_images/figure12.png" />
<figcaption>
<p><span class="caption-text">Figure 12: Non-inverting Op-Amp configuration and voltage gain equation <a class="footnote-reference brackets" href="#id45" id="id22">1</a>.</span><a class="headerlink" href="#id75" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Non-idealities of real-life Op-Amps will also affect the circuit, the most influential of which is
determined by a given IC’s strengths and weaknesses. A notable non-ideality can be seen in gain
bandwidth and subsequent frequency response. Finite GBW/GBP of an Op-Amp produces
attributes of an active lowpass filter. With the lower cutoff frequency determined by the GBP
divided by the gain of the circuit <a class="footnote-reference brackets" href="#id51" id="id23">7</a>. As a result, open-loop response often has high gain with
very low cutoff frequency. Whereas closed-loop gain will keep gain approximately constant for a
much wider bandwidth.</p>
<figure class="align-center" id="id76">
<img alt="../_images/image0211.png" src="../_images/image0211.png" />
<figcaption>
<p><span class="caption-text">Figure 13: LM741 Frequency response in open and closed loop configurations <a class="footnote-reference brackets" href="#id53" id="id24">9</a>.</span><a class="headerlink" href="#id76" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id77">
<img alt="../_images/image022.png" src="../_images/image022.png" />
<figcaption>
<p><span class="caption-text">Figure 14: Gain Bandwidth formula <a class="footnote-reference brackets" href="#id53" id="id25">9</a>.</span><a class="headerlink" href="#id77" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Other non-idealities of Op-Amps are limits on output current, voltage, and slew rate.
Output voltage can become saturated due to voltage gain exceeding the supply rails. Current
supplied by an Op-Amp IC is highly dependent on a model, and current limits may be imposed
for safety of the internal circuitry. The maximum rate of change for an Op-Amps output voltage
is referred to as its slew rate. Op-Amps are slew rate limited at frequencies of operation that
require a faster rate than the IC can permit.</p>
</section>
<section id="first-order-filter-theory">
<h3>First-Order Filter Theory<a class="headerlink" href="#first-order-filter-theory" title="Permalink to this headline"></a></h3>
<p>Analog filters are a method of reducing gain of responses at certain frequencies. First-order
filters implement a singular cutoff frequency while second order filters implement multiple
cutoff frequencies. Filters can be implemented in active and passive configurations, meaning
with and without Op-Amps respectively. Regardless of a filter being passive or active, Filter
frequencies and modes of operation are created between RL and RC components. Figure 15
implements passive and active filters in multiple filter configurations.</p>
<figure class="align-center" id="id78">
<img alt="../_images/image023.png" src="../_images/image023.png" />
<figcaption>
<p><span class="caption-text">Figure 15: First order filter table with active and passive applications <a class="footnote-reference brackets" href="#id45" id="id26">1</a>.</span><a class="headerlink" href="#id78" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="audio-amplifier-configuration">
<h3>Audio Amplifier Configuration<a class="headerlink" href="#audio-amplifier-configuration" title="Permalink to this headline"></a></h3>
<p>The audio amplifier circuit has a simple implementation. The primary goal was creating a
circuit with 26dB gain (20V/V) using the LM386. This was easily accomplished by referring to
the LM386 datasheet as they provide applications in section 9 of the document (Figure 16) <a class="footnote-reference brackets" href="#id55" id="id27">11</a>.
Implementation can be seen on the schematic, Figure 22. I made no changes to the circuit
recommended by the datasheet.</p>
<figure class="align-center" id="id79">
<img alt="../_images/image024.png" src="../_images/image024.png" />
<figcaption>
<p><span class="caption-text">Figure 16: LM386 Wiring Diagram for a gain of 20 <a class="footnote-reference brackets" href="#id55" id="id28">11</a>.</span><a class="headerlink" href="#id79" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="power-regulation-and-filtering">
<h3>Power Regulation and Filtering<a class="headerlink" href="#power-regulation-and-filtering" title="Permalink to this headline"></a></h3>
<p>To supply power to the system, I chose to use the LM2940 5V low-dropout regulator.
This allows for a 9-12V DC source to supply the devices without much overhead. This provided
a smooth 5V source for most components, with local decoupling capacitors where needed. The
LM2940 is a prime candidate for 5V regulation as its implementation is simple, only requiring
two capacitors on the Vin and Vout <a class="footnote-reference brackets" href="#id54" id="id29">10</a>. I implemented an array of values for the output
capacitors out of an abundance of safety and a desire for a highly filtered power source <a class="footnote-reference brackets" href="#id46" id="id30">2</a>, <a class="footnote-reference brackets" href="#id48" id="id31">4</a>, <a class="footnote-reference brackets" href="#id64" id="id32">20</a>.</p>
<figure class="align-center" id="id80">
<img alt="../_images/image025.png" src="../_images/image025.png" />
<figcaption>
<p><span class="caption-text">Figure 17: LM2940 LDO Wiring Diagram <a class="footnote-reference brackets" href="#id54" id="id33">10</a>.</span><a class="headerlink" href="#id80" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>In addition to the 5V source, I powered the Raspberry Pico via the VSYS node to activate
the device and use the 3.3V Switching Mode Power Supply (SMPS). This was done using a
Schottky diode from 5V to VSYS to avoid backflow when the Pico is plugged in via USB [15].
The Pico power-chain is good because the SMPS is efficient, but noise on the output causes
problems with other systems like the ADC <a class="footnote-reference brackets" href="#id59" id="id34">15</a>, <a class="footnote-reference brackets" href="#id60" id="id35">16</a>. As a result, I added bypass capacitors to this
source as well.</p>
<figure class="align-center" id="id81">
<img alt="../_images/figure18.png" src="../_images/figure18.png" />
<figcaption>
<p><span class="caption-text">Figure 18: Pico Power-chain and the implemented method of external supply <a class="footnote-reference brackets" href="#id54" id="id36">10</a>.</span><a class="headerlink" href="#id81" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="inputs-and-outputs">
<h3>Inputs and Outputs<a class="headerlink" href="#inputs-and-outputs" title="Permalink to this headline"></a></h3>
<p>Buttons, switches, and LEDs are integrated into the design for various controls and
system status. All inputs are setup in a pull-down configuration. Wave selection is controlled by
the active switches while both menu selection and software resets are controlled by the buttons.
This allows for a robust interface system to be implemented in software. GPIO selected for these
pins were selected last to ensure critical systems had placement. Button debouncing was taken
care of in software by implementing a delay after initial triggering. Alternatively, these buttons
could be debounced using small bypass capacitors such as a 100nF, creating a linear voltage
response for the IO pin instead of a bouncing signal. All buttons, switches, and output LED’s use
the 3.3V source from the SMPS as to not damage GPIO pins on the Pico. They are also paired
with 220-ohm resistors to give the LED’s maximum brightness in a safe current range.</p>
</section>
<section id="ultrasonic-sensors">
<h3>Ultrasonic Sensors<a class="headerlink" href="#ultrasonic-sensors" title="Permalink to this headline"></a></h3>
<p>The HC-SR04 is an Ultrasonic sensor module that uses sonar to determine distance of
objects similar to echolocation seen in animals like bats or dolphins <a class="footnote-reference brackets" href="#id52" id="id37">8</a>. It is rated for distances
of 2cm to 400cm and can provide high accuracy within this range. The sensors have four
connections, VCC, Trig, Echo, and GND. The device operates with a 5V supply, while the
trigger and echo are used to communicate digital data between the sensor and a microcontroller.</p>
<p>From the microcontroller, the Trig pin is set high for 10uS then brought low. This tells
the sensor to send eight 40kHz bursts from the transmitter. The microcontroller should then poll
the Echo pin, waiting for a high signal from the receiver, indicating the return of the bursts echo.
The time between the rising and falling edge of the Echo pin can be used to calculate distance
based on the speed of sound, 343 m/s. Based on the distances calculated from each sensor, we
can modify output sound data.</p>
<figure class="align-center" id="id82">
<img alt="../_images/image028.png" src="../_images/image028.png" />
<figcaption>
<p><span class="caption-text">Figure 19: Ultrasonic sensor timing diagram <a class="footnote-reference brackets" href="#id52" id="id38">8</a>.</span><a class="headerlink" href="#id82" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="lcd-configuration">
<h3>LCD Configuration<a class="headerlink" href="#lcd-configuration" title="Permalink to this headline"></a></h3>
<p>Configuration of the Crystal Fontz AH1602Z-YYH for parallel communication was a
major step in setup of this circuit. I chose to use parallel communication to interact with the LCD
as opposed to SPI or I2C for simplicity and use of previous code. The LCD is wired in parallel to
the microcontroller with four-bit communication <a class="footnote-reference brackets" href="#id63" id="id39">19</a>. A potentiometer was connected for
contrast control of the LCD, and a photoresistor and 1k-ohm resistor was connected in parallel
for adaptive brightness control. For parallel communication, a nibble of data is sent to the display
simultaneously. Full bytes of data are then sent to the device in a process called bit-banging. This
splits a byte of data to send two nibbles in series, communicating the upper four bits and then the
lower four bits. For wiring of the device, previous lecture slides and LCD driver manual were
helpful in wiring and debugging issues with contrast and brightness <a class="footnote-reference brackets" href="#id63" id="id40">19</a>.</p>
</section>
<section id="theremin-circuit-configuration">
<h3>Theremin Circuit Configuration<a class="headerlink" href="#theremin-circuit-configuration" title="Permalink to this headline"></a></h3>
<p>The various components are connected in a circuit following the hardware diagram and
schematics seen below. 9V Power is connected via a barrel jack and regulated to 5V, supplying
the Pico through a Schottky diode. An LED is also driven by the 5V rail to indicate a power on
status and a switch is present to cut off the 9V power to the circuit entirely. The 3.3V output of
the Pico is used for all buttons, switches, and output LEDs. Two potentiometers are connected
between 3.3V and ground with the wiper connecting to ADC pins, allowing variable analog input
to the system. Switches, Buttons, and output LEDs are 3.3V pull-downs available for menu and
waveform controls.</p>
<p>The DAC and audio amplifier are connected in series, followed by an 8-ohm speaker,
presenting the Analog output waveform. Another potentiometer was connected between the
DAC and amplifier to provide a coarse volume control on the output. Digital output in the form
of Status LEDs indicate continuous operation by toggling and display on reset of the device.</p>
<figure class="align-center" id="id83">
<img alt="../_images/image029.png" src="../_images/image029.png" />
<figcaption>
<p><span class="caption-text">Figure 20: Hardware Block Diagram of the Theremin Circuit.</span><a class="headerlink" href="#id83" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>A single processor flow was employed for reliability and simplicity. To help speed up
operations, a generous overclock was applied, setting the system clock to 270MHz. The Pico
would start by initializing SPI communication at 10MHz, LCD parallel communication, and
Ultrasonic sensor communication. This was followed by all other GPIO initialization, definition
of button interrupts, and creating the waveform generation process in the timer tick.</p>
<p>The Pico would then enter its program loop, where a startup splash screen would be
displayed along with lighting all LEDs. All variables would also be set to their default state.
Pressing the reset button would return the user to this point in the program.</p>
<p>The main loop would then be entered and would continue until the reset button is pressed.
In this process, the ADC, ultrasonic sensors, and switches are all polled for data. Depending on
the state of the display menu set by button interrupts, the ADCs could set the frequency or
amplitude range for computation later. The LCD prints a display associated with the current
menu state. If both sensors detect the hands of the user, frequency and amplitude is then
calculated based on the current boundaries for each and the ultrasonic sensor data. The timer is
then started or adjusted for frequency shifts, and the processor sends SPI data to the DAC for
output. If the sensors do not detect objects or a waveform is not selected with a switch, sound
will not be output. Lastly, the onboard LED is toggled and the loop restarts for the duration of
instrument use.</p>
<figure class="align-center" id="id84">
<img alt="../_images/image030.png" src="../_images/image030.png" />
<figcaption>
<p><span class="caption-text">Figure 21: Software Block Diagram of the Theremin Circuit.</span><a class="headerlink" href="#id84" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="schematic-and-pcb-design">
<h3>Schematic and PCB Design<a class="headerlink" href="#schematic-and-pcb-design" title="Permalink to this headline"></a></h3>
<p>All previously mentioned components must be compiled into a schematic design for
wiring structure and PCB design. Useful tips and tricks for understanding the Altium can be
learned by watching Professor Stapleton’s videos <a class="footnote-reference brackets" href="#id57" id="id41">13</a>.</p>
<p>The most useful design points are regarding power and capacitor placement. Bypass and
decoupling capacitors are added to the board for several reasons. First, capacitors can be used on
power headers to avoid voltage spikes and removing AC ripple on DC power. Small ceramic
caps offer low series resistance and react fast but have a difficult time dealing with substantial
amounts of charge over long periods. Polarized electrolytic capacitors usually have a much
higher capacitance, and in conjunction with smaller ceramic capacitors, effectively clean DC
voltage <a class="footnote-reference brackets" href="#id46" id="id42">2</a>, <a class="footnote-reference brackets" href="#id57" id="id43">13</a>. In larger schematics and PCB’s, we are not always able to position circuits near
bypass capacitors. Therefore, small decoupling capacitors are recommended for placement near a
circuit subsection to help clean AC ripple from DC voltages <a class="footnote-reference brackets" href="#id48" id="id44">4</a>.</p>
<p>Once the schematic was populated with all necessary circuit components, the PCB was
updated with all schematic components for board layout. A general layout of parts was done
before resizing the board outline to find the most effective use of space. When all components
have found their relative placement, routing traces for components using auto-routing tools or
manually is required. I chose to auto-route, followed with manual edits to correct some trace
routes. I found 20mil routes were sufficient for this circuit. Copper pours are also recommended
for adding a ground or Vcc layer to the PCB, further simplifying routing design and common
routes. I implemented a Ground and 5V layer using the copper pours.</p>
<figure class="align-center" id="id85">
<img alt="../_images/image031.png" src="../_images/image031.png" />
<figcaption>
<p><span class="caption-text">Figure 22: Ultrasonic Theremin schematic page 1 of 2.</span><a class="headerlink" href="#id85" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id86">
<img alt="../_images/image032.png" src="../_images/image032.png" />
<figcaption>
<p><span class="caption-text">Figure 23: Ultrasonic Theremin schematic page 2 of 2.</span><a class="headerlink" href="#id86" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id87">
<img alt="../_images/image033.png" src="../_images/image033.png" />
<figcaption>
<p><span class="caption-text">Figure 24: Top side of Ultrasonic Theremin PCB layout.</span><a class="headerlink" href="#id87" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="bill-of-materials">
<h3>Bill Of Materials<a class="headerlink" href="#bill-of-materials" title="Permalink to this headline"></a></h3>
<table class="docutils align-default" id="id88">
<caption><span class="caption-text">Bill Of Materials</span><a class="headerlink" href="#id88" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>Description</p></td>
<td><p>Designators</p></td>
<td><p>Quantity</p></td>
<td><p>Price</p></td>
<td><p>Component Total</p></td>
</tr>
<tr class="row-even"><td><p>1000uF Cap</p></td>
<td><p>Electrolytic Capacitor</p></td>
<td><p>C15</p></td>
<td><p>1</p></td>
<td><p>$1.60</p></td>
<td><p>$1.60</p></td>
</tr>
<tr class="row-odd"><td><p>270uF Cap</p></td>
<td><p>Electrolytic Capacitor</p></td>
<td><p>C2</p></td>
<td><p>1</p></td>
<td><p>$0.33</p></td>
<td><p>$0.33</p></td>
</tr>
<tr class="row-even"><td><p>100uF Cap</p></td>
<td><p>Electrolytic Capacitor</p></td>
<td><p>C7</p></td>
<td><p>1</p></td>
<td><p>$0.09</p></td>
<td><p>$0.09</p></td>
</tr>
<tr class="row-odd"><td><p>10uF Cap</p></td>
<td><p>Electrolytic Capacitor</p></td>
<td><p>C13, C14, C19</p></td>
<td><p>3</p></td>
<td><p>$0.07</p></td>
<td><p>$0.21</p></td>
</tr>
<tr class="row-even"><td><p>1uF Cap</p></td>
<td><p>Electrolytic Capacitor</p></td>
<td><p>C8, C9, C11, C12, C18</p></td>
<td><p>5</p></td>
<td><p>$0.06</p></td>
<td><p>$0.30</p></td>
</tr>
<tr class="row-odd"><td><p>0.47uF Cap</p></td>
<td><p>Electrolytic Capacitor</p></td>
<td><p>C10</p></td>
<td><p>1</p></td>
<td><p>$0.09</p></td>
<td><p>$0.09</p></td>
</tr>
<tr class="row-even"><td><p>0.1uF Cap</p></td>
<td><p>Ceramic Capacitor</p></td>
<td><p>C1, C4, C5, C6, C16, C17, C20</p></td>
<td><p>7</p></td>
<td><p>$0.09</p></td>
<td><p>$0.63</p></td>
</tr>
<tr class="row-odd"><td><p>50pF Cap</p></td>
<td><p>Ceramic Capacitor</p></td>
<td><p>C2</p></td>
<td><p>1</p></td>
<td><p>$0.17</p></td>
<td><p>$0.17</p></td>
</tr>
<tr class="row-even"><td><p>10K Pots</p></td>
<td><p>3-pin Potentiometer</p></td>
<td><p>R1, R5, R15, R16</p></td>
<td><p>4</p></td>
<td><p>$1.13</p></td>
<td><p>$4.52</p></td>
</tr>
<tr class="row-odd"><td><p>1K Res</p></td>
<td><p>axial Resistor</p></td>
<td><p>R2, R4, R6</p></td>
<td><p>3</p></td>
<td><p>$0.05</p></td>
<td><p>$0.15</p></td>
</tr>
<tr class="row-even"><td><p>220  Res</p></td>
<td><p>axial Resistor</p></td>
<td><p>R7, R8, R9, R10, R11, R12, 
R13, R14, R17, R18</p></td>
<td><p>10</p></td>
<td><p>$0.03</p></td>
<td><p>$0.28</p></td>
</tr>
<tr class="row-odd"><td><p>Photoresistor</p></td>
<td><p>Photoresistor</p></td>
<td><p>R3</p></td>
<td><p>1</p></td>
<td><p>$1.18</p></td>
<td><p>$1.18</p></td>
</tr>
<tr class="row-even"><td><p>LEDs</p></td>
<td><p>5mm LED</p></td>
<td><p>D1, D2, D3, D4, D5, D7, D8</p></td>
<td><p>7</p></td>
<td><p>$0.09</p></td>
<td><p>$0.63</p></td>
</tr>
<tr class="row-odd"><td><p>LCD44780</p></td>
<td><p>16x2 LCD Display</p></td>
<td><p>DS1</p></td>
<td><p>1</p></td>
<td><p>$6.27</p></td>
<td><p>$6.27</p></td>
</tr>
<tr class="row-even"><td><p>LTC1661</p></td>
<td><p>10bit DAC</p></td>
<td><p>U3</p></td>
<td><p>1</p></td>
<td><p>$6.21</p></td>
<td><p>$6.21</p></td>
</tr>
<tr class="row-odd"><td><p>LM386</p></td>
<td><p>Audio Amplifier</p></td>
<td><p>U1</p></td>
<td><p>1</p></td>
<td><p>$1.50</p></td>
<td><p>$1.50</p></td>
</tr>
<tr class="row-even"><td><p>8 Ohm Speaker</p></td>
<td><p>8 Ohm Speaker</p></td>
<td><p>P6</p></td>
<td><p>1</p></td>
<td><p>$4.68</p></td>
<td><p>$4.68</p></td>
</tr>
<tr class="row-odd"><td><p>LM2940</p></td>
<td><p>5V LDO Regulator</p></td>
<td><p>U4</p></td>
<td><p>1</p></td>
<td><p>$2.70</p></td>
<td><p>$2.70</p></td>
</tr>
<tr class="row-even"><td><p>1N5819</p></td>
<td><p>Schottky Diode</p></td>
<td><p>D6</p></td>
<td><p>1</p></td>
<td><p>$0.28</p></td>
<td><p>$0.28</p></td>
</tr>
<tr class="row-odd"><td><p>9V Adapter</p></td>
<td><p>AC/DC Adapter</p></td>
<td><p>N/A</p></td>
<td><p>1</p></td>
<td><p>$7.99</p></td>
<td><p>$7.99</p></td>
</tr>
<tr class="row-even"><td><p>Barrel Jack</p></td>
<td><p>Female Connector</p></td>
<td><p>P7</p></td>
<td><p>1</p></td>
<td><p>$0.71</p></td>
<td><p>$0.71</p></td>
</tr>
<tr class="row-odd"><td><p>SPST Switch</p></td>
<td><p>SPST Switch</p></td>
<td><p>P8</p></td>
<td><p>1</p></td>
<td><p>$2.15</p></td>
<td><p>$2.15</p></td>
</tr>
<tr class="row-even"><td><p>HC-SR04</p></td>
<td><p>Ultrasonic Sensors</p></td>
<td><p>P4, P5</p></td>
<td><p>2</p></td>
<td><p>$3.75</p></td>
<td><p>$7.50</p></td>
</tr>
<tr class="row-odd"><td><p>Pico</p></td>
<td><p>Raspberry Pico uP</p></td>
<td><p>U2</p></td>
<td><p>1</p></td>
<td><p>$4.00</p></td>
<td><p>$4.00</p></td>
</tr>
<tr class="row-even"><td><p>SW_DIP 4</p></td>
<td><p>DIP Switch package</p></td>
<td><p>S1</p></td>
<td><p>1</p></td>
<td><p>$0.59</p></td>
<td><p>$0.59</p></td>
</tr>
<tr class="row-odd"><td><p>Buttons</p></td>
<td><p>Buttons</p></td>
<td><p>S2, S3, S4, S5</p></td>
<td><p>4</p></td>
<td><p>$1.18</p></td>
<td><p>$4.72</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td><p>Project Total:</p></td>
<td><p>$59.48</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this headline"></a></h2>
<p>The schematic of the circuit and PCB turned out well, with minimal errors. The
assembled PCB was easy to debug because of its plentiful headers employed in the diagram.
Also, using female headers for the ultrasonic sensors, LCD, DIP packages, and potentiometers
aided debug and ensured that any errors in design could be more easily fixed if the PCB was
routed wrong. Thankfully, there were no design breaking errors in this circuit, and most
components worked immediately after installation.</p>
<figure class="align-center" id="id89">
<img alt="../_images/image034.png" src="../_images/image034.png" />
<figcaption>
<p><span class="caption-text">Figure 25: Empty Theremin Circuit PCB.</span><a class="headerlink" href="#id89" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id90">
<img alt="../_images/image036.jpg" src="../_images/image036.jpg" />
<figcaption>
<p><span class="caption-text">Figure 26: Populated Theremin Circuit PCB.</span><a class="headerlink" href="#id90" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<section id="power">
<h3>Power<a class="headerlink" href="#power" title="Permalink to this headline"></a></h3>
<p>The power regulation and filtering produced a 5V source with minimal noise, observed
with as little as 10mV ripple on the source. Extra filtering on the 3.3V source also seemed
fruitful but may benefit from a larger array of capacitances to further smooth the ~30-40mV
ripple observed on the device pin. This is a slight improvement on the unfiltered 3.3V rail.</p>
<figure class="align-center" id="id91">
<img alt="../_images/image037.jpg" src="../_images/image037.jpg" />
<figcaption>
<p><span class="caption-text">Figure 27: Power regulation system on the PCB</span><a class="headerlink" href="#id91" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id92">
<img alt="../_images/image038.png" src="../_images/image038.png" />
<figcaption>
<p><span class="caption-text">Figure 28: 5V source observed on the oscilloscope.</span><a class="headerlink" href="#id92" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id93">
<img alt="../_images/image039.png" src="../_images/image039.png" />
<figcaption>
<p><span class="caption-text">Figure 29: 3.3V source observed on the oscilloscope.</span><a class="headerlink" href="#id93" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="audio">
<h3>Audio<a class="headerlink" href="#audio" title="Permalink to this headline"></a></h3>
<p>The audio system of this circuit had no issue driving the 8-ohm speaker for a variety of
32-step waveforms. The coarse volume potentiometer helped easily remove clipping from the
amplifier stage. Frequencies of 160Hz were achievable with system stability. Frequencies up to
240 were achieved using this audio configuration, however this boost is audio transaction
demand.</p>
<section id="without-speaker-load">
<h4>Without Speaker Load<a class="headerlink" href="#without-speaker-load" title="Permalink to this headline"></a></h4>
<figure class="align-center" id="id94">
<img alt="../_images/audio.jpg" src="../_images/audio.jpg" />
<figcaption>
<p><span class="caption-text">Figure 30: Audio output system.</span><a class="headerlink" href="#id94" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id95">
<img alt="../_images/image040.png" src="../_images/image040.png" />
<figcaption>
<p><span class="caption-text">Figure 31: Sine wave output of the Audio Amplifier without speaker load.</span><a class="headerlink" href="#id95" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id96">
<img alt="../_images/image041.png" src="../_images/image041.png" />
<figcaption>
<p><span class="caption-text">Figure 32: Square wave output of the Audio Amplifier without speaker load.</span><a class="headerlink" href="#id96" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id97">
<img alt="../_images/image042.png" src="../_images/image042.png" />
<figcaption>
<p><span class="caption-text">Figure 33: Triangle wave output of the Audio Amplifier without speaker load.</span><a class="headerlink" href="#id97" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id98">
<img alt="../_images/image043.png" src="../_images/image043.png" />
<figcaption>
<p><span class="caption-text">Figure 34: Sawtooth wave output of the Audio Amplifier without speaker load.</span><a class="headerlink" href="#id98" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="with-speaker-load">
<h4>With Speaker Load<a class="headerlink" href="#with-speaker-load" title="Permalink to this headline"></a></h4>
<p>The audio amplifier with an 8-ohm speaker creates an RC circuit, and adds capacitive
loading and unloading. Slight hiccupping of the output waveform can also be observed due to
issues with the python interpreter, as well as variation in frequency/amplitude from ultrasonic
sensors when sampling.</p>
<figure class="align-center" id="id99">
<img alt="../_images/image044.png" src="../_images/image044.png" />
<figcaption>
<p><span class="caption-text">Figure 35: Sine wave output of the Audio Amplifier with speaker load.</span><a class="headerlink" href="#id99" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id100">
<img alt="../_images/image045.png" src="../_images/image045.png" />
<figcaption>
<p><span class="caption-text">Figure 36: Square wave output of the Audio Amplifier with speaker load.</span><a class="headerlink" href="#id100" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id101">
<img alt="../_images/image046.png" src="../_images/image046.png" />
<figcaption>
<p><span class="caption-text">Figure 37: Triangle wave output of the Audio Amplifier with speaker load.</span><a class="headerlink" href="#id101" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id102">
<img alt="../_images/image047.png" src="../_images/image047.png" />
<figcaption>
<p><span class="caption-text">Figure 38: Sawtooth wave output of the Audio Amplifier with speaker load.</span><a class="headerlink" href="#id102" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
</section>
<section id="interface-and-display">
<h3>Interface and Display<a class="headerlink" href="#interface-and-display" title="Permalink to this headline"></a></h3>
<p>The finished theremin circuit displayed its menu system intuitively. On startup, the splash
screen displays the project name and system clock, while holding the yellow and onboard LEDs
high. After the splash screen, the system hits the home screen to display waveform, frequency,
and amplitude readings in real time. DIP switches control the wave types, allowing sine, square,
triangle, and sawtooth from left to right. Once both sensors detect objects, they display the
potential frequency and amplitude of the wave. The output signal is only generated when both
sensors detect, and a waveform switch is selected.</p>
<figure class="align-center" id="id103">
<img alt="../_images/figure39.png" src="../_images/figure39.png" />
<figcaption>
<p><span class="caption-text">Figure 39: Splash screen on system reset.</span><a class="headerlink" href="#id103" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id104">
<img alt="../_images/figure40.png" src="../_images/figure40.png" />
<figcaption>
<p><span class="caption-text">Figure 40: Home screen with waveform selection, frequency, and amplitude readings.</span><a class="headerlink" href="#id104" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id105">
<img alt="../_images/figure41.png" src="../_images/figure41.png" />
<figcaption>
<p><span class="caption-text">Figure 41: Amplitude and frequency boundary menu.</span><a class="headerlink" href="#id105" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id106">
<img alt="../_images/image054.jpg" src="../_images/image054.jpg" />
<figcaption>
<p><span class="caption-text">Figure 42: Ultrasonic Theremin in its case.</span><a class="headerlink" href="#id106" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id107">
<img alt="../_images/image055.jpg" src="../_images/image055.jpg" />
<figcaption>
<p><span class="caption-text">Figure 43: Close up of the ultrasonic theremin in its case.</span><a class="headerlink" href="#id107" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
</section>
<section id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Permalink to this headline"></a></h2>
<p>Overall, the ultrasonic theremin circuit was a success. It has some minor problems that
can be solved with small modifications to the PCB or software, but performs its task as expected.
In terms of the power system, the regulation of the 5V source was excellent, however my
smoothing of the 3.3V leaved something to be desired. This could be improved upon by adding
more capacitance on the output rail. However, for our purposes of the 3.3V rail this is
unnecessary. If I was to use the onboard ADC for more detail-oriented measurements, I would
consider using an external LDO for 3.3V regulation, or work on filtering this 3.3V rail more.
Regarding layout and the schematic, I believe that the design worked very well. There are minor
changes for ease of use I would make with more time. These issues include moving C12 out of
the Pico’s USB port area, taking more time to implement exact potentiometer footprints, and
creating larger holes for the speaker wires.</p>
<p>The audio output system could be improved by adding a coupling capacitor on the signal
line between the DAC and the LM386, as well as removal of the potentiometer from the signal
path to reduce noise. With the removal of the potentiometer, it could alternatively be placed on
the DAC reference to provide a similar result and reduce signal noise. LM386 amplification and
filtering could be improved slightly, but for the purposes of this device I believe the current
configuration is sufficient and could be improved mostly by my former critiques. Frequency
range could also be improved by exploring multithreading, DMA, or other software efficiency
systems to isolate data transactions to the DAC. Not exploring these avenues leaves considerable
improvement available on the software architecture, but overclocking allowed for a proof of
concept in demonstration.</p>
<p>Ultimately, the ultrasonic theremin was an interesting and unique project. We applied a
variety of systems to bring together a working solution. Hardware included concepts of power
regulation and filtering, I/O, LCD data display, and analog amplification. Software concepts of
ADC and DAC conversions, interrupt service routines, debouncing, hardware timers,
overclocking, parallel and SPI communication, and lookup tables were Implemented. Most
systems were implemented well enough to meet project requirements and expectations. Room
for improvement leaves potential for a revision of both the circuit and code, allowing for easier
use, higher frequencies, and better responsiveness.</p>
</section>
<section id="appendix">
<h2>Appendix<a class="headerlink" href="#appendix" title="Permalink to this headline"></a></h2>
<section id="lcd-py">
<h3>LCD.py<a class="headerlink" href="#lcd-py" title="Permalink to this headline"></a></h3>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">#--------------------------------------------------</span>
<span class="linenos">  2</span><span class="c1">#       PARALLEL LCD FUNCTIONS</span>
<span class="linenos">  3</span><span class="c1">#       ======================</span>
<span class="linenos">  4</span><span class="c1">#</span>
<span class="linenos">  5</span><span class="c1"># These functions initialize and control the LCD</span>
<span class="linenos">  6</span><span class="c1">#</span>
<span class="linenos">  7</span><span class="c1"># Author: Dogan Ibrahim</span>
<span class="linenos">  8</span><span class="c1"># File  : LCD</span>
<span class="linenos">  9</span><span class="c1"># Date  : August, 2021</span>
<span class="linenos"> 10</span><span class="c1">#--------------------------------------------------</span>
<span class="linenos"> 11</span><span class="c1"># Modified by Dieter Steinhauser</span>
<span class="linenos"> 12</span><span class="c1">#--------------------------------------------------</span>
<span class="linenos"> 13</span><span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">Pin</span>
<span class="linenos"> 14</span><span class="kn">import</span> <span class="nn">utime</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="c1"># ----------------------</span>
<span class="linenos"> 17</span><span class="n">LCD_CMD</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 18</span><span class="n">LCD_DATA</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos"> 19</span><span class="c1"># ----------------------</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="c1"># GPIO Wiring</span>
<span class="linenos"> 22</span><span class="c1"># ----------------------</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="c1">#! Wiring here is backwards because of issues in layout.</span>
<span class="linenos"> 25</span><span class="n">EN</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 26</span><span class="n">RS</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 27</span><span class="n">D4</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 28</span><span class="n">D5</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 29</span><span class="n">D6</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 30</span><span class="n">D7</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 31</span><span class="n">PORT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="linenos"> 32</span><span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span><span class="c1"># Methods</span>
<span class="linenos"> 36</span><span class="c1"># ----------------------</span>
<span class="linenos"> 37</span>
<span class="linenos"> 38</span><span class="k">def</span> <span class="nf">Configure</span><span class="p">():</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
<span class="linenos"> 41</span>       <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="n">PORT</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 42</span>    
<span class="linenos"> 43</span><span class="k">def</span> <span class="nf">lcd_strobe</span><span class="p">():</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span>    <span class="n">EN</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 46</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 47</span>    <span class="n">EN</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 48</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 49</span>    
<span class="linenos"> 50</span><span class="k">def</span> <span class="nf">lcd_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 53</span>       <span class="n">d</span> <span class="o">=</span> <span class="n">c</span>
<span class="linenos"> 54</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 55</span>       <span class="n">d</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="linenos"> 56</span>    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
<span class="linenos"> 57</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
<span class="linenos"> 58</span>        <span class="n">b</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="mi">1</span>
<span class="linenos"> 59</span>        <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="linenos"> 60</span>        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
<span class="linenos"> 61</span>    <span class="n">RS</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
<span class="linenos"> 62</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos"> 63</span>    
<span class="linenos"> 64</span>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 65</span>       <span class="n">d</span> <span class="o">=</span> <span class="n">c</span>
<span class="linenos"> 66</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 67</span>       <span class="n">d</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="linenos"> 68</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
<span class="linenos"> 69</span>        <span class="n">b</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="mi">1</span>
<span class="linenos"> 70</span>        <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="linenos"> 71</span>        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
<span class="linenos"> 72</span>    <span class="n">RS</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
<span class="linenos"> 73</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos"> 74</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 75</span>    <span class="n">RS</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span><span class="k">def</span> <span class="nf">lcd_clear</span><span class="p">():</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 80</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="k">def</span> <span class="nf">lcd_home</span><span class="p">():</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 85</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="k">def</span> <span class="nf">lcd_cursor_blink</span><span class="p">():</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x0D</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 90</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="k">def</span> <span class="nf">lcd_cursor_on</span><span class="p">():</span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x0E</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 95</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span><span class="k">def</span> <span class="nf">lcd_cursor_off</span><span class="p">():</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">100</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">101</span>
<span class="linenos">102</span><span class="k">def</span> <span class="nf">lcd_puts</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="linenos">103</span>
<span class="linenos">104</span>    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="linenos">105</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
<span class="linenos">106</span>       <span class="n">lcd_putch</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="linenos">107</span>
<span class="linenos">108</span><span class="k">def</span> <span class="nf">lcd_putch</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
<span class="linenos">109</span>
<span class="linenos">110</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">111</span>
<span class="linenos">112</span><span class="k">def</span> <span class="nf">lcd_goto</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
<span class="linenos">113</span>    <span class="n">c</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">114</span>    <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">115</span>        <span class="n">address</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">116</span>    <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">117</span>        <span class="n">address</span> <span class="o">=</span> <span class="mh">0x40</span>
<span class="linenos">118</span>    <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">119</span>        <span class="n">address</span> <span class="o">=</span> <span class="mh">0x14</span>
<span class="linenos">120</span>    <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos">121</span>        <span class="n">address</span> <span class="o">=</span> <span class="mh">0x54</span>
<span class="linenos">122</span>    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span> <span class="o">+</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span>
<span class="linenos">123</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">124</span>
<span class="linenos">125</span><span class="k">def</span> <span class="nf">lcd_init</span><span class="p">():</span>
<span class="linenos">126</span>    
<span class="linenos">127</span>    <span class="n">Configure</span><span class="p">()</span>
<span class="linenos">128</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
<span class="linenos">129</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
<span class="linenos">130</span>        <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">131</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="linenos">132</span>    <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">133</span>    <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">134</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos">135</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">136</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos">137</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">138</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos">139</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">140</span>    <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">141</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos">142</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos">143</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">144</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">145</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">146</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">147</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">148</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">149</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x06</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">150</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos">151</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">152</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">153</span><span class="c1">#================= END OF LCD FUNCTIONS =======================</span>
<span class="linenos">154</span>
<span class="linenos">155</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="lut-py">
<h3>LUT.py<a class="headerlink" href="#lut-py" title="Permalink to this headline"></a></h3>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">  2</span><span class="c1">#                 NOTES </span>
<span class="linenos">  3</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">  4</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  5</span>
<span class="linenos">  6</span><span class="sd">Dieter Steinhauser</span>
<span class="linenos">  7</span><span class="sd">10/1/2022</span>
<span class="linenos">  8</span><span class="sd">Design 1</span>
<span class="linenos">  9</span><span class="sd">DAC Lookup Tables</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span><span class="sd">The following are lists of 32 and 256 words that assemble one period</span>
<span class="linenos"> 12</span><span class="sd">of a waveform</span>
<span class="linenos"> 13</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 16</span><span class="c1">#                 CONSTANTS</span>
<span class="linenos"> 17</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 18</span>
<span class="linenos"> 19</span><span class="n">FREQ_MAX</span> <span class="o">=</span> <span class="mi">100</span>
<span class="linenos"> 20</span><span class="n">FREQ_MIN</span> <span class="o">=</span> <span class="mi">10</span>
<span class="linenos"> 21</span><span class="n">DAC_WRITE_THRU_A</span> <span class="o">=</span> <span class="mh">0x9</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="c1"># WRITE_THRU_A</span>
<span class="linenos"> 22</span><span class="n">DAC_WRITE_THRU_B</span> <span class="o">=</span> <span class="mh">0xA</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="c1"># WRITE_THRU_B</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 25</span><span class="c1">#                 LUTS</span>
<span class="linenos"> 26</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span><span class="c1"># 10 bit res</span>
<span class="linenos"> 29</span><span class="n">SQUARE_WAVE_LUT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1023</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span><span class="n">SQUARE_WAVE_LUT_256</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">128</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1023</span><span class="p">]</span><span class="o">*</span><span class="mi">128</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span><span class="c1"># 10 bit res</span>
<span class="linenos"> 35</span><span class="n">SAWTOOTH_WAVE_LUT</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span><span class="n">SAWTOOTH_WAVE_LUT_256</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="linenos"> 38</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="c1"># 10 bit res</span>
<span class="linenos"> 41</span><span class="n">SINE_WAVE_LUT</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x264</span><span class="p">,</span><span class="mh">0x2c4</span><span class="p">,</span><span class="mh">0x31c</span><span class="p">,</span><span class="mh">0x36a</span><span class="p">,</span><span class="mh">0x3aa</span><span class="p">,</span><span class="mh">0x3d9</span><span class="p">,</span><span class="mh">0x3f6</span><span class="p">,</span><span class="mh">0x400</span><span class="p">,</span><span class="mh">0x3f6</span><span class="p">,</span><span class="mh">0x3d9</span><span class="p">,</span><span class="mh">0x3aa</span><span class="p">,</span><span class="mh">0x36a</span><span class="p">,</span><span class="mh">0x31c</span><span class="p">,</span><span class="mh">0x2c4</span><span class="p">,</span><span class="mh">0x264</span><span class="p">,</span>
<span class="linenos"> 42</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x19c</span><span class="p">,</span><span class="mh">0x13c</span><span class="p">,</span><span class="mh">0xe4</span><span class="p">,</span><span class="mh">0x96</span><span class="p">,</span><span class="mh">0x56</span><span class="p">,</span><span class="mh">0x27</span><span class="p">,</span><span class="mh">0xa</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0xa</span><span class="p">,</span><span class="mh">0x27</span><span class="p">,</span><span class="mh">0x56</span><span class="p">,</span><span class="mh">0x96</span><span class="p">,</span><span class="mh">0xe4</span><span class="p">,</span><span class="mh">0x13c</span><span class="p">,</span><span class="mh">0x19c</span><span class="p">]</span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="n">SINE_WAVE_LUT_256</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x20c</span><span class="p">,</span><span class="mh">0x219</span><span class="p">,</span><span class="mh">0x225</span><span class="p">,</span><span class="mh">0x232</span><span class="p">,</span><span class="mh">0x23e</span><span class="p">,</span><span class="mh">0x24b</span><span class="p">,</span><span class="mh">0x257</span><span class="p">,</span><span class="mh">0x263</span><span class="p">,</span><span class="mh">0x270</span><span class="p">,</span><span class="mh">0x27c</span><span class="p">,</span><span class="mh">0x288</span><span class="p">,</span><span class="mh">0x294</span><span class="p">,</span><span class="mh">0x2a0</span><span class="p">,</span><span class="mh">0x2ac</span><span class="p">,</span><span class="mh">0x2b8</span><span class="p">,</span>
<span class="linenos"> 46</span><span class="mh">0x2c3</span><span class="p">,</span><span class="mh">0x2cf</span><span class="p">,</span><span class="mh">0x2da</span><span class="p">,</span><span class="mh">0x2e5</span><span class="p">,</span><span class="mh">0x2f1</span><span class="p">,</span><span class="mh">0x2fc</span><span class="p">,</span><span class="mh">0x306</span><span class="p">,</span><span class="mh">0x311</span><span class="p">,</span><span class="mh">0x31c</span><span class="p">,</span><span class="mh">0x326</span><span class="p">,</span><span class="mh">0x330</span><span class="p">,</span><span class="mh">0x33a</span><span class="p">,</span><span class="mh">0x344</span><span class="p">,</span><span class="mh">0x34e</span><span class="p">,</span><span class="mh">0x357</span><span class="p">,</span><span class="mh">0x360</span><span class="p">,</span>
<span class="linenos"> 47</span><span class="mh">0x369</span><span class="p">,</span><span class="mh">0x372</span><span class="p">,</span><span class="mh">0x37a</span><span class="p">,</span><span class="mh">0x383</span><span class="p">,</span><span class="mh">0x38b</span><span class="p">,</span><span class="mh">0x393</span><span class="p">,</span><span class="mh">0x39a</span><span class="p">,</span><span class="mh">0x3a2</span><span class="p">,</span><span class="mh">0x3a9</span><span class="p">,</span><span class="mh">0x3b0</span><span class="p">,</span><span class="mh">0x3b6</span><span class="p">,</span><span class="mh">0x3bd</span><span class="p">,</span><span class="mh">0x3c3</span><span class="p">,</span><span class="mh">0x3c8</span><span class="p">,</span><span class="mh">0x3ce</span><span class="p">,</span><span class="mh">0x3d3</span><span class="p">,</span>
<span class="linenos"> 48</span><span class="mh">0x3d8</span><span class="p">,</span><span class="mh">0x3dd</span><span class="p">,</span><span class="mh">0x3e1</span><span class="p">,</span><span class="mh">0x3e5</span><span class="p">,</span><span class="mh">0x3e9</span><span class="p">,</span><span class="mh">0x3ec</span><span class="p">,</span><span class="mh">0x3f0</span><span class="p">,</span><span class="mh">0x3f3</span><span class="p">,</span><span class="mh">0x3f5</span><span class="p">,</span><span class="mh">0x3f7</span><span class="p">,</span><span class="mh">0x3f9</span><span class="p">,</span><span class="mh">0x3fb</span><span class="p">,</span><span class="mh">0x3fd</span><span class="p">,</span><span class="mh">0x3fe</span><span class="p">,</span><span class="mh">0x3fe</span><span class="p">,</span><span class="mh">0x3ff</span><span class="p">,</span>
<span class="linenos"> 49</span><span class="mh">0x3ff</span><span class="p">,</span><span class="mh">0x3ff</span><span class="p">,</span><span class="mh">0x3fe</span><span class="p">,</span><span class="mh">0x3fe</span><span class="p">,</span><span class="mh">0x3fd</span><span class="p">,</span><span class="mh">0x3fb</span><span class="p">,</span><span class="mh">0x3f9</span><span class="p">,</span><span class="mh">0x3f7</span><span class="p">,</span><span class="mh">0x3f5</span><span class="p">,</span><span class="mh">0x3f3</span><span class="p">,</span><span class="mh">0x3f0</span><span class="p">,</span><span class="mh">0x3ec</span><span class="p">,</span><span class="mh">0x3e9</span><span class="p">,</span><span class="mh">0x3e5</span><span class="p">,</span><span class="mh">0x3e1</span><span class="p">,</span><span class="mh">0x3dd</span><span class="p">,</span>
<span class="linenos"> 50</span><span class="mh">0x3d8</span><span class="p">,</span><span class="mh">0x3d3</span><span class="p">,</span><span class="mh">0x3ce</span><span class="p">,</span><span class="mh">0x3c8</span><span class="p">,</span><span class="mh">0x3c3</span><span class="p">,</span><span class="mh">0x3bd</span><span class="p">,</span><span class="mh">0x3b6</span><span class="p">,</span><span class="mh">0x3b0</span><span class="p">,</span><span class="mh">0x3a9</span><span class="p">,</span><span class="mh">0x3a2</span><span class="p">,</span><span class="mh">0x39a</span><span class="p">,</span><span class="mh">0x393</span><span class="p">,</span><span class="mh">0x38b</span><span class="p">,</span><span class="mh">0x383</span><span class="p">,</span><span class="mh">0x37a</span><span class="p">,</span><span class="mh">0x372</span><span class="p">,</span>
<span class="linenos"> 51</span><span class="mh">0x369</span><span class="p">,</span><span class="mh">0x360</span><span class="p">,</span><span class="mh">0x357</span><span class="p">,</span><span class="mh">0x34e</span><span class="p">,</span><span class="mh">0x344</span><span class="p">,</span><span class="mh">0x33a</span><span class="p">,</span><span class="mh">0x330</span><span class="p">,</span><span class="mh">0x326</span><span class="p">,</span><span class="mh">0x31c</span><span class="p">,</span><span class="mh">0x311</span><span class="p">,</span><span class="mh">0x306</span><span class="p">,</span><span class="mh">0x2fc</span><span class="p">,</span><span class="mh">0x2f1</span><span class="p">,</span><span class="mh">0x2e5</span><span class="p">,</span><span class="mh">0x2da</span><span class="p">,</span><span class="mh">0x2cf</span><span class="p">,</span>
<span class="linenos"> 52</span><span class="mh">0x2c3</span><span class="p">,</span><span class="mh">0x2b8</span><span class="p">,</span><span class="mh">0x2ac</span><span class="p">,</span><span class="mh">0x2a0</span><span class="p">,</span><span class="mh">0x294</span><span class="p">,</span><span class="mh">0x288</span><span class="p">,</span><span class="mh">0x27c</span><span class="p">,</span><span class="mh">0x270</span><span class="p">,</span><span class="mh">0x263</span><span class="p">,</span><span class="mh">0x257</span><span class="p">,</span><span class="mh">0x24b</span><span class="p">,</span><span class="mh">0x23e</span><span class="p">,</span><span class="mh">0x232</span><span class="p">,</span><span class="mh">0x225</span><span class="p">,</span><span class="mh">0x219</span><span class="p">,</span><span class="mh">0x20c</span><span class="p">,</span>
<span class="linenos"> 53</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x1f3</span><span class="p">,</span><span class="mh">0x1e6</span><span class="p">,</span><span class="mh">0x1da</span><span class="p">,</span><span class="mh">0x1cd</span><span class="p">,</span><span class="mh">0x1c1</span><span class="p">,</span><span class="mh">0x1b4</span><span class="p">,</span><span class="mh">0x1a8</span><span class="p">,</span><span class="mh">0x19c</span><span class="p">,</span><span class="mh">0x18f</span><span class="p">,</span><span class="mh">0x183</span><span class="p">,</span><span class="mh">0x177</span><span class="p">,</span><span class="mh">0x16b</span><span class="p">,</span><span class="mh">0x15f</span><span class="p">,</span><span class="mh">0x153</span><span class="p">,</span><span class="mh">0x147</span><span class="p">,</span>
<span class="linenos"> 54</span><span class="mh">0x13c</span><span class="p">,</span><span class="mh">0x130</span><span class="p">,</span><span class="mh">0x125</span><span class="p">,</span><span class="mh">0x11a</span><span class="p">,</span><span class="mh">0x10e</span><span class="p">,</span><span class="mh">0x103</span><span class="p">,</span><span class="mh">0xf9</span><span class="p">,</span><span class="mh">0xee</span><span class="p">,</span><span class="mh">0xe3</span><span class="p">,</span><span class="mh">0xd9</span><span class="p">,</span><span class="mh">0xcf</span><span class="p">,</span><span class="mh">0xc5</span><span class="p">,</span><span class="mh">0xbb</span><span class="p">,</span><span class="mh">0xb1</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">,</span><span class="mh">0x9f</span><span class="p">,</span>
<span class="linenos"> 55</span><span class="mh">0x96</span><span class="p">,</span><span class="mh">0x8d</span><span class="p">,</span><span class="mh">0x85</span><span class="p">,</span><span class="mh">0x7c</span><span class="p">,</span><span class="mh">0x74</span><span class="p">,</span><span class="mh">0x6c</span><span class="p">,</span><span class="mh">0x65</span><span class="p">,</span><span class="mh">0x5d</span><span class="p">,</span><span class="mh">0x56</span><span class="p">,</span><span class="mh">0x4f</span><span class="p">,</span><span class="mh">0x49</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0x3c</span><span class="p">,</span><span class="mh">0x37</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x2c</span><span class="p">,</span>
<span class="linenos"> 56</span><span class="mh">0x27</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x1e</span><span class="p">,</span><span class="mh">0x1a</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="mh">0xf</span><span class="p">,</span><span class="mh">0xc</span><span class="p">,</span><span class="mh">0xa</span><span class="p">,</span><span class="mh">0x8</span><span class="p">,</span><span class="mh">0x6</span><span class="p">,</span><span class="mh">0x4</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span>
<span class="linenos"> 57</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span><span class="mh">0x4</span><span class="p">,</span><span class="mh">0x6</span><span class="p">,</span><span class="mh">0x8</span><span class="p">,</span><span class="mh">0xa</span><span class="p">,</span><span class="mh">0xc</span><span class="p">,</span><span class="mh">0xf</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0x1a</span><span class="p">,</span><span class="mh">0x1e</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span>
<span class="linenos"> 58</span><span class="mh">0x27</span><span class="p">,</span><span class="mh">0x2c</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x37</span><span class="p">,</span><span class="mh">0x3c</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0x49</span><span class="p">,</span><span class="mh">0x4f</span><span class="p">,</span><span class="mh">0x56</span><span class="p">,</span><span class="mh">0x5d</span><span class="p">,</span><span class="mh">0x65</span><span class="p">,</span><span class="mh">0x6c</span><span class="p">,</span><span class="mh">0x74</span><span class="p">,</span><span class="mh">0x7c</span><span class="p">,</span><span class="mh">0x85</span><span class="p">,</span><span class="mh">0x8d</span><span class="p">,</span>
<span class="linenos"> 59</span><span class="mh">0x96</span><span class="p">,</span><span class="mh">0x9f</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">,</span><span class="mh">0xb1</span><span class="p">,</span><span class="mh">0xbb</span><span class="p">,</span><span class="mh">0xc5</span><span class="p">,</span><span class="mh">0xcf</span><span class="p">,</span><span class="mh">0xd9</span><span class="p">,</span><span class="mh">0xe3</span><span class="p">,</span><span class="mh">0xee</span><span class="p">,</span><span class="mh">0xf9</span><span class="p">,</span><span class="mh">0x103</span><span class="p">,</span><span class="mh">0x10e</span><span class="p">,</span><span class="mh">0x11a</span><span class="p">,</span><span class="mh">0x125</span><span class="p">,</span><span class="mh">0x130</span><span class="p">,</span>
<span class="linenos"> 60</span><span class="mh">0x13c</span><span class="p">,</span><span class="mh">0x147</span><span class="p">,</span><span class="mh">0x153</span><span class="p">,</span><span class="mh">0x15f</span><span class="p">,</span><span class="mh">0x16b</span><span class="p">,</span><span class="mh">0x177</span><span class="p">,</span><span class="mh">0x183</span><span class="p">,</span><span class="mh">0x18f</span><span class="p">,</span><span class="mh">0x19c</span><span class="p">,</span><span class="mh">0x1a8</span><span class="p">,</span><span class="mh">0x1b4</span><span class="p">,</span><span class="mh">0x1c1</span><span class="p">,</span><span class="mh">0x1cd</span><span class="p">,</span><span class="mh">0x1da</span><span class="p">,</span><span class="mh">0x1e6</span><span class="p">,</span><span class="mh">0x1f3</span><span class="p">]</span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span><span class="c1"># 10 bit res</span>
<span class="linenos"> 63</span><span class="n">TRIANGLE_WAVE_LUT</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0x140</span><span class="p">,</span><span class="mh">0x180</span><span class="p">,</span><span class="mh">0x1c0</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x240</span><span class="p">,</span><span class="mh">0x280</span><span class="p">,</span><span class="mh">0x2c0</span><span class="p">,</span><span class="mh">0x300</span><span class="p">,</span><span class="mh">0x340</span><span class="p">,</span><span class="mh">0x380</span><span class="p">,</span><span class="mh">0x3c0</span><span class="p">,</span><span class="mh">0x400</span><span class="p">,</span>
<span class="linenos"> 64</span><span class="mh">0x3c0</span><span class="p">,</span><span class="mh">0x380</span><span class="p">,</span><span class="mh">0x340</span><span class="p">,</span><span class="mh">0x300</span><span class="p">,</span><span class="mh">0x2c0</span><span class="p">,</span><span class="mh">0x280</span><span class="p">,</span><span class="mh">0x240</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x1c0</span><span class="p">,</span><span class="mh">0x180</span><span class="p">,</span><span class="mh">0x140</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x0</span><span class="p">]</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span><span class="n">TRIANGLE_WAVE_LUT_256</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x8</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span>
<span class="linenos"> 67</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mh">0x98</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span><span class="mh">0xb8</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">,</span><span class="mh">0xc8</span><span class="p">,</span><span class="mh">0xd0</span><span class="p">,</span><span class="mh">0xd8</span><span class="p">,</span><span class="mh">0xe0</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">,</span><span class="mh">0xf0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span>
<span class="linenos"> 68</span><span class="mh">0x108</span><span class="p">,</span><span class="mh">0x110</span><span class="p">,</span><span class="mh">0x118</span><span class="p">,</span><span class="mh">0x120</span><span class="p">,</span><span class="mh">0x128</span><span class="p">,</span><span class="mh">0x130</span><span class="p">,</span><span class="mh">0x138</span><span class="p">,</span><span class="mh">0x140</span><span class="p">,</span><span class="mh">0x148</span><span class="p">,</span><span class="mh">0x150</span><span class="p">,</span><span class="mh">0x158</span><span class="p">,</span><span class="mh">0x160</span><span class="p">,</span><span class="mh">0x168</span><span class="p">,</span><span class="mh">0x170</span><span class="p">,</span><span class="mh">0x178</span><span class="p">,</span><span class="mh">0x180</span><span class="p">,</span>
<span class="linenos"> 69</span><span class="mh">0x188</span><span class="p">,</span><span class="mh">0x190</span><span class="p">,</span><span class="mh">0x198</span><span class="p">,</span><span class="mh">0x1a0</span><span class="p">,</span><span class="mh">0x1a8</span><span class="p">,</span><span class="mh">0x1b0</span><span class="p">,</span><span class="mh">0x1b8</span><span class="p">,</span><span class="mh">0x1c0</span><span class="p">,</span><span class="mh">0x1c8</span><span class="p">,</span><span class="mh">0x1d0</span><span class="p">,</span><span class="mh">0x1d8</span><span class="p">,</span><span class="mh">0x1e0</span><span class="p">,</span><span class="mh">0x1e8</span><span class="p">,</span><span class="mh">0x1f0</span><span class="p">,</span><span class="mh">0x1f8</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span>
<span class="linenos"> 70</span><span class="mh">0x207</span><span class="p">,</span><span class="mh">0x20f</span><span class="p">,</span><span class="mh">0x217</span><span class="p">,</span><span class="mh">0x21f</span><span class="p">,</span><span class="mh">0x227</span><span class="p">,</span><span class="mh">0x22f</span><span class="p">,</span><span class="mh">0x237</span><span class="p">,</span><span class="mh">0x23f</span><span class="p">,</span><span class="mh">0x247</span><span class="p">,</span><span class="mh">0x24f</span><span class="p">,</span><span class="mh">0x257</span><span class="p">,</span><span class="mh">0x25f</span><span class="p">,</span><span class="mh">0x267</span><span class="p">,</span><span class="mh">0x26f</span><span class="p">,</span><span class="mh">0x277</span><span class="p">,</span><span class="mh">0x27f</span><span class="p">,</span>
<span class="linenos"> 71</span><span class="mh">0x287</span><span class="p">,</span><span class="mh">0x28f</span><span class="p">,</span><span class="mh">0x297</span><span class="p">,</span><span class="mh">0x29f</span><span class="p">,</span><span class="mh">0x2a7</span><span class="p">,</span><span class="mh">0x2af</span><span class="p">,</span><span class="mh">0x2b7</span><span class="p">,</span><span class="mh">0x2bf</span><span class="p">,</span><span class="mh">0x2c7</span><span class="p">,</span><span class="mh">0x2cf</span><span class="p">,</span><span class="mh">0x2d7</span><span class="p">,</span><span class="mh">0x2df</span><span class="p">,</span><span class="mh">0x2e7</span><span class="p">,</span><span class="mh">0x2ef</span><span class="p">,</span><span class="mh">0x2f7</span><span class="p">,</span><span class="mh">0x2ff</span><span class="p">,</span>
<span class="linenos"> 72</span><span class="mh">0x307</span><span class="p">,</span><span class="mh">0x30f</span><span class="p">,</span><span class="mh">0x317</span><span class="p">,</span><span class="mh">0x31f</span><span class="p">,</span><span class="mh">0x327</span><span class="p">,</span><span class="mh">0x32f</span><span class="p">,</span><span class="mh">0x337</span><span class="p">,</span><span class="mh">0x33f</span><span class="p">,</span><span class="mh">0x347</span><span class="p">,</span><span class="mh">0x34f</span><span class="p">,</span><span class="mh">0x357</span><span class="p">,</span><span class="mh">0x35f</span><span class="p">,</span><span class="mh">0x367</span><span class="p">,</span><span class="mh">0x36f</span><span class="p">,</span><span class="mh">0x377</span><span class="p">,</span><span class="mh">0x37f</span><span class="p">,</span>
<span class="linenos"> 73</span><span class="mh">0x387</span><span class="p">,</span><span class="mh">0x38f</span><span class="p">,</span><span class="mh">0x397</span><span class="p">,</span><span class="mh">0x39f</span><span class="p">,</span><span class="mh">0x3a7</span><span class="p">,</span><span class="mh">0x3af</span><span class="p">,</span><span class="mh">0x3b7</span><span class="p">,</span><span class="mh">0x3bf</span><span class="p">,</span><span class="mh">0x3c7</span><span class="p">,</span><span class="mh">0x3cf</span><span class="p">,</span><span class="mh">0x3d7</span><span class="p">,</span><span class="mh">0x3df</span><span class="p">,</span><span class="mh">0x3e7</span><span class="p">,</span><span class="mh">0x3ef</span><span class="p">,</span><span class="mh">0x3f7</span><span class="p">,</span><span class="mh">0x3ff</span><span class="p">,</span>
<span class="linenos"> 74</span><span class="mh">0x3f7</span><span class="p">,</span><span class="mh">0x3ef</span><span class="p">,</span><span class="mh">0x3e7</span><span class="p">,</span><span class="mh">0x3df</span><span class="p">,</span><span class="mh">0x3d7</span><span class="p">,</span><span class="mh">0x3cf</span><span class="p">,</span><span class="mh">0x3c7</span><span class="p">,</span><span class="mh">0x3bf</span><span class="p">,</span><span class="mh">0x3b7</span><span class="p">,</span><span class="mh">0x3af</span><span class="p">,</span><span class="mh">0x3a7</span><span class="p">,</span><span class="mh">0x39f</span><span class="p">,</span><span class="mh">0x397</span><span class="p">,</span><span class="mh">0x38f</span><span class="p">,</span><span class="mh">0x387</span><span class="p">,</span><span class="mh">0x37f</span><span class="p">,</span>
<span class="linenos"> 75</span><span class="mh">0x377</span><span class="p">,</span><span class="mh">0x36f</span><span class="p">,</span><span class="mh">0x367</span><span class="p">,</span><span class="mh">0x35f</span><span class="p">,</span><span class="mh">0x357</span><span class="p">,</span><span class="mh">0x34f</span><span class="p">,</span><span class="mh">0x347</span><span class="p">,</span><span class="mh">0x33f</span><span class="p">,</span><span class="mh">0x337</span><span class="p">,</span><span class="mh">0x32f</span><span class="p">,</span><span class="mh">0x327</span><span class="p">,</span><span class="mh">0x31f</span><span class="p">,</span><span class="mh">0x317</span><span class="p">,</span><span class="mh">0x30f</span><span class="p">,</span><span class="mh">0x307</span><span class="p">,</span><span class="mh">0x2ff</span><span class="p">,</span>
<span class="linenos"> 76</span><span class="mh">0x2f7</span><span class="p">,</span><span class="mh">0x2ef</span><span class="p">,</span><span class="mh">0x2e7</span><span class="p">,</span><span class="mh">0x2df</span><span class="p">,</span><span class="mh">0x2d7</span><span class="p">,</span><span class="mh">0x2cf</span><span class="p">,</span><span class="mh">0x2c7</span><span class="p">,</span><span class="mh">0x2bf</span><span class="p">,</span><span class="mh">0x2b7</span><span class="p">,</span><span class="mh">0x2af</span><span class="p">,</span><span class="mh">0x2a7</span><span class="p">,</span><span class="mh">0x29f</span><span class="p">,</span><span class="mh">0x297</span><span class="p">,</span><span class="mh">0x28f</span><span class="p">,</span><span class="mh">0x287</span><span class="p">,</span><span class="mh">0x27f</span><span class="p">,</span>
<span class="linenos"> 77</span><span class="mh">0x277</span><span class="p">,</span><span class="mh">0x26f</span><span class="p">,</span><span class="mh">0x267</span><span class="p">,</span><span class="mh">0x25f</span><span class="p">,</span><span class="mh">0x257</span><span class="p">,</span><span class="mh">0x24f</span><span class="p">,</span><span class="mh">0x247</span><span class="p">,</span><span class="mh">0x23f</span><span class="p">,</span><span class="mh">0x237</span><span class="p">,</span><span class="mh">0x22f</span><span class="p">,</span><span class="mh">0x227</span><span class="p">,</span><span class="mh">0x21f</span><span class="p">,</span><span class="mh">0x217</span><span class="p">,</span><span class="mh">0x20f</span><span class="p">,</span><span class="mh">0x207</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span>
<span class="linenos"> 78</span><span class="mh">0x1f8</span><span class="p">,</span><span class="mh">0x1f0</span><span class="p">,</span><span class="mh">0x1e8</span><span class="p">,</span><span class="mh">0x1e0</span><span class="p">,</span><span class="mh">0x1d8</span><span class="p">,</span><span class="mh">0x1d0</span><span class="p">,</span><span class="mh">0x1c8</span><span class="p">,</span><span class="mh">0x1c0</span><span class="p">,</span><span class="mh">0x1b8</span><span class="p">,</span><span class="mh">0x1b0</span><span class="p">,</span><span class="mh">0x1a8</span><span class="p">,</span><span class="mh">0x1a0</span><span class="p">,</span><span class="mh">0x198</span><span class="p">,</span><span class="mh">0x190</span><span class="p">,</span><span class="mh">0x188</span><span class="p">,</span><span class="mh">0x180</span><span class="p">,</span>
<span class="linenos"> 79</span><span class="mh">0x178</span><span class="p">,</span><span class="mh">0x170</span><span class="p">,</span><span class="mh">0x168</span><span class="p">,</span><span class="mh">0x160</span><span class="p">,</span><span class="mh">0x158</span><span class="p">,</span><span class="mh">0x150</span><span class="p">,</span><span class="mh">0x148</span><span class="p">,</span><span class="mh">0x140</span><span class="p">,</span><span class="mh">0x138</span><span class="p">,</span><span class="mh">0x130</span><span class="p">,</span><span class="mh">0x128</span><span class="p">,</span><span class="mh">0x120</span><span class="p">,</span><span class="mh">0x118</span><span class="p">,</span><span class="mh">0x110</span><span class="p">,</span><span class="mh">0x108</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span>
<span class="linenos"> 80</span><span class="mh">0xf8</span><span class="p">,</span><span class="mh">0xf0</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">,</span><span class="mh">0xe0</span><span class="p">,</span><span class="mh">0xd8</span><span class="p">,</span><span class="mh">0xd0</span><span class="p">,</span><span class="mh">0xc8</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">,</span><span class="mh">0xb8</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="mh">0x98</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span>
<span class="linenos"> 81</span><span class="mh">0x78</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x8</span><span class="p">,</span><span class="mh">0x0</span><span class="p">]</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 85</span><span class="c1">#                STRUCTURES</span>
<span class="linenos"> 86</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 87</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="k">class</span> <span class="nc">Waveform</span><span class="p">:</span>
<span class="linenos"> 90</span>    <span class="sd">&quot;&quot;&quot;Class to store info on the waveform functions&quot;&quot;&quot;</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">switch</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lut</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="linenos"> 93</span>        
<span class="linenos"> 94</span>        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lut</span><span class="p">)</span>
<span class="linenos"> 95</span>        <span class="bp">self</span><span class="o">.</span><span class="n">switch</span> <span class="o">=</span> <span class="n">switch</span> <span class="c1">#: Switch associated with the waveform</span>
<span class="linenos"> 96</span>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="c1">#: Name String of the waveform</span>
<span class="linenos"> 97</span>        <span class="bp">self</span><span class="o">.</span><span class="n">lut</span> <span class="o">=</span> <span class="n">lut</span> <span class="c1">#: Lookup table for the waveform</span>
<span class="linenos"> 98</span>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="c1">#: size of the lookup table </span>
<span class="linenos"> 99</span>        <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1">#: last index of the lookup table</span>
<span class="linenos">100</span>
<span class="linenos">101</span>        <span class="c1"># Generate the burst table. This formats data for continuous writing of words to the DAC.</span>
<span class="linenos">102</span>        <span class="n">burst_lut</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">103</span>        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">lut</span><span class="p">:</span>
<span class="linenos">104</span>            <span class="n">burst_lut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DAC_WRITE_THRU_A</span> <span class="o">|</span> <span class="p">(</span><span class="n">element</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span>
<span class="linenos">105</span>
<span class="linenos">106</span>        <span class="bp">self</span><span class="o">.</span><span class="n">burst_lut</span> <span class="o">=</span> <span class="n">burst_lut</span> <span class="c1">#: Word table for continuous writing of data to the DAC through DMA.</span>
<span class="linenos">107</span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="n">sine</span> <span class="o">=</span> <span class="n">Waveform</span><span class="p">(</span><span class="s1">&#39;SW0&#39;</span><span class="p">,</span>     <span class="s1">&#39;sine    &#39;</span><span class="p">,</span> <span class="n">SINE_WAVE_LUT</span><span class="p">)</span>
<span class="linenos">110</span><span class="n">square</span> <span class="o">=</span> <span class="n">Waveform</span><span class="p">(</span><span class="s1">&#39;SW1&#39;</span><span class="p">,</span>   <span class="s1">&#39;square  &#39;</span><span class="p">,</span> <span class="n">SQUARE_WAVE_LUT</span><span class="p">)</span>
<span class="linenos">111</span><span class="n">triangle</span> <span class="o">=</span> <span class="n">Waveform</span><span class="p">(</span><span class="s1">&#39;SW2&#39;</span><span class="p">,</span> <span class="s1">&#39;triangle&#39;</span><span class="p">,</span> <span class="n">TRIANGLE_WAVE_LUT</span><span class="p">)</span>
<span class="linenos">112</span><span class="n">sawtooth</span> <span class="o">=</span> <span class="n">Waveform</span><span class="p">(</span><span class="s1">&#39;SW3&#39;</span><span class="p">,</span> <span class="s1">&#39;sawtooth&#39;</span><span class="p">,</span> <span class="n">SAWTOOTH_WAVE_LUT</span><span class="p">)</span>
<span class="linenos">113</span>
<span class="linenos">114</span><span class="n">waveforms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SW0&#39;</span><span class="p">:</span> <span class="n">sine</span><span class="p">,</span> 
<span class="linenos">115</span>             <span class="s1">&#39;SW1&#39;</span><span class="p">:</span> <span class="n">square</span><span class="p">,</span> 
<span class="linenos">116</span>             <span class="s1">&#39;SW2&#39;</span><span class="p">:</span> <span class="n">triangle</span><span class="p">,</span> 
<span class="linenos">117</span>             <span class="s1">&#39;SW3&#39;</span><span class="p">:</span> <span class="n">sawtooth</span><span class="p">}</span>
<span class="linenos">118</span>
<span class="linenos">119</span>
<span class="linenos">120</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">121</span><span class="c1">#                END OF FILE</span>
<span class="linenos">122</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">123</span>
<span class="linenos">124</span>
<span class="linenos">125</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="spi-config-py">
<h3>spi_config.py<a class="headerlink" href="#spi-config-py" title="Permalink to this headline"></a></h3>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 2</span><span class="c1">#          NOTES </span>
<span class="linenos"> 3</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 4</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="sd">Dieter Steinhauser</span>
<span class="linenos"> 7</span><span class="sd">11/2022</span>
<span class="linenos"> 8</span><span class="sd">Design 1</span>
<span class="linenos"> 9</span><span class="sd">SPI configuration</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="sd">The following is configuration of SPI communication for the LTC1661 10-bit DAC.</span>
<span class="linenos">12</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">15</span><span class="c1">#          IMPORTS</span>
<span class="linenos">16</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">17</span><span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">SPI</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">20</span><span class="c1">#          CONSTANTS</span>
<span class="linenos">21</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">22</span><span class="n">DEBUG_SPI_CLK</span> <span class="o">=</span> <span class="mi">1_000_000</span> <span class="c1"># Hz</span>
<span class="linenos">23</span><span class="n">STABLE_SPI_CLK</span> <span class="o">=</span> <span class="mi">8_000_000</span> <span class="c1"># Hz</span>
<span class="linenos">24</span><span class="n">FAST_SPI_CLK</span> <span class="o">=</span> <span class="mi">10_000_000</span> <span class="c1"># Hz</span>
<span class="linenos">25</span><span class="n">IDLE_LO</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">26</span><span class="n">IDLE_HI</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">27</span><span class="n">RISING_EDGE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">28</span><span class="n">FALLING_EDGE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">31</span><span class="c1">#           SPI</span>
<span class="linenos">32</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="c1"># Note: How to configure SPI</span>
<span class="linenos">35</span><span class="c1"># ---------------------------</span>
<span class="linenos">36</span><span class="c1"># spi.init(baudrate=1_000_000,  # clock speed</span>
<span class="linenos">37</span>         <span class="c1"># polarity=0,          # Idle clock level. 0:L, 1:H</span>
<span class="linenos">38</span>         <span class="c1"># phase=0,             # sample on rising(0) or falling (1) edge</span>
<span class="linenos">39</span>         <span class="c1"># bits=8,              # width of transfer in bits, 8 is standard</span>
<span class="linenos">40</span>         <span class="c1"># firstbit=SPI.MSB,    # bit order, either SPI.MSB or SPI.LSB</span>
<span class="linenos">41</span>         <span class="c1"># sck=None,            # alternate pin object selection </span>
<span class="linenos">42</span>         <span class="c1"># mosi=None,           # alternate pin object selection </span>
<span class="linenos">43</span>         <span class="c1"># miso=None,           # alternate pin object selection </span>
<span class="linenos">44</span>         <span class="c1"># pins=(SCK, MOSI, MISO) # alternate pin object selection for WiPy</span>
<span class="linenos">45</span>         <span class="c1"># )</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="c1"># spi.write(&#39;test&#39;) # single write to the device</span>
<span class="linenos">48</span><span class="c1"># spi.read(num_bytes)       # read a number of bytes. can take a second parameter of a continuous write byte value.</span>
<span class="linenos">49</span><span class="c1"># </span>
<span class="linenos">50</span><span class="c1"># buf = bytearray(3)</span>
<span class="linenos">51</span><span class="c1"># spi.write_readinto(&#39;out&#39;, read_buf) # writes the first value while reading into the second parameter read_buf</span>
<span class="linenos">52</span><span class="c1"># ---------------------------</span>
<span class="linenos">53</span>
<span class="linenos">54</span><span class="n">spi_clock_speed</span> <span class="o">=</span> <span class="n">FAST_SPI_CLK</span>
<span class="linenos">55</span><span class="n">spi</span> <span class="o">=</span> <span class="n">SPI</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">56</span><span class="c1"># Default Pins for SPI-0</span>
<span class="linenos">57</span><span class="c1"># CLK  - 18</span>
<span class="linenos">58</span><span class="c1"># MOSI - 19</span>
<span class="linenos">59</span><span class="c1"># MISO - 16</span>
<span class="linenos">60</span><span class="c1"># CS   - 17 #Note, if this does not work immeadiately, enable the pin as an output as seen below. </span>
<span class="linenos">61</span>
<span class="linenos">62</span><span class="n">cs</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">63</span>
<span class="linenos">64</span><span class="n">spi</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">baudrate</span><span class="o">=</span><span class="n">spi_clock_speed</span><span class="p">,</span>  <span class="c1"># clock speed</span>
<span class="linenos">65</span>         <span class="n">polarity</span><span class="o">=</span><span class="n">IDLE_LO</span><span class="p">,</span>    <span class="c1"># Idle clock level. 0:L, 1:H</span>
<span class="linenos">66</span>         <span class="n">phase</span><span class="o">=</span><span class="n">RISING_EDGE</span><span class="p">,</span>    <span class="c1"># sample on rising(0) or falling (1) edge</span>
<span class="linenos">67</span>         <span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="theremin-py">
<h3>theremin.py<a class="headerlink" href="#theremin-py" title="Permalink to this headline"></a></h3>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">  2</span><span class="c1">#                 NOTES </span>
<span class="linenos">  3</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">  4</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  5</span><span class="sd">Dieter Steinhauser</span>
<span class="linenos">  6</span><span class="sd">11/2022</span>
<span class="linenos">  7</span><span class="sd">Design 1</span>
<span class="linenos">  8</span><span class="sd">Ultrasonic Theremin</span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span><span class="sd">This program employs talks to various peripherals to create a theremin music device.</span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span><span class="sd">The Major components include:</span>
<span class="linenos"> 13</span><span class="sd">Transfers of SPI data to DAC</span>
<span class="linenos"> 14</span><span class="sd">LCD status</span>
<span class="linenos"> 15</span><span class="sd">ADC conversions</span>
<span class="linenos"> 16</span><span class="sd">Switch inputs</span>
<span class="linenos"> 17</span><span class="sd">button inputs</span>
<span class="linenos"> 18</span><span class="sd">Overclocking</span>
<span class="linenos"> 19</span>
<span class="linenos"> 20</span><span class="sd">Potentially:</span>
<span class="linenos"> 21</span><span class="sd">multithreading</span>
<span class="linenos"> 22</span><span class="sd">DMA</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 27</span><span class="c1">#               IMPORTS</span>
<span class="linenos"> 28</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span><span class="kn">from</span> <span class="nn">LCD</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 31</span><span class="kn">from</span> <span class="nn">LUT</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 32</span><span class="kn">from</span> <span class="nn">spi_config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 33</span><span class="kn">import</span> <span class="nn">_thread</span>
<span class="linenos"> 34</span><span class="kn">from</span> <span class="nn">utime</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">sleep_ms</span><span class="p">,</span> <span class="n">sleep_us</span><span class="p">,</span> <span class="n">ticks_ms</span>
<span class="linenos"> 35</span><span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">Timer</span><span class="p">,</span> <span class="n">ADC</span><span class="p">,</span> <span class="n">freq</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 38</span><span class="c1">#         CONSTANTS/VARIABLES</span>
<span class="linenos"> 39</span><span class="c1"># -----------------------------------------   </span>
<span class="linenos"> 40</span>
<span class="linenos"> 41</span><span class="c1"># ------------------</span>
<span class="linenos"> 42</span><span class="n">REFRESH_RATE</span> <span class="o">=</span> <span class="mi">60</span> <span class="c1"># Frequency in Hz</span>
<span class="linenos"> 43</span><span class="n">REFRESH_PERIOD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">REFRESH_RATE</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># delay in milliseconds</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="c1"># ------------------</span>
<span class="linenos"> 46</span><span class="n">UPY_BIT_RES</span> <span class="o">=</span> <span class="mi">16</span>
<span class="linenos"> 47</span><span class="n">ADC_REF</span> <span class="o">=</span> <span class="mf">3.3</span>
<span class="linenos"> 48</span><span class="n">VOLT_PER_BIT</span> <span class="o">=</span> <span class="n">ADC_REF</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">UPY_BIT_RES</span><span class="p">)</span> <span class="c1"># ADC recieves in 2 byte packets and micropython automagically fixes it.</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="c1"># ------------------</span>
<span class="linenos"> 51</span><span class="n">DAC_REF</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="linenos"> 52</span><span class="n">DC_OFFSET</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 53</span><span class="n">DC_OFFSET_RES</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">DC_OFFSET</span> <span class="o">/</span> <span class="n">DAC_REF</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">UPY_BIT_RES</span><span class="p">))</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="c1"># ------------------</span>
<span class="linenos"> 56</span><span class="n">FREQ_MAX</span> <span class="o">=</span> <span class="mi">100</span>
<span class="linenos"> 57</span><span class="n">FREQ_MIN</span> <span class="o">=</span> <span class="mi">10</span>
<span class="linenos"> 58</span><span class="n">AMP_MAX</span> <span class="o">=</span> <span class="n">DAC_REF</span>
<span class="linenos"> 59</span><span class="n">AMP_MIN</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="n">MAX_DIST_US0</span> <span class="o">=</span> <span class="mi">50</span>
<span class="linenos"> 62</span><span class="n">MAX_DIST_US1</span> <span class="o">=</span> <span class="mi">20</span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 65</span><span class="c1">#           METHODS</span>
<span class="linenos"> 66</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="k">def</span> <span class="nf">append_space</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
<span class="linenos"> 69</span>    <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">):</span>
<span class="linenos"> 70</span>        <span class="n">string</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">string</span>
<span class="linenos"> 71</span>    <span class="k">return</span> <span class="n">string</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span><span class="c1"># -------------------------------------------------------------</span>
<span class="linenos"> 74</span><span class="c1">#           INITIALIZATION</span>
<span class="linenos"> 75</span><span class="c1"># -------------------------------------------------------------</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 78</span><span class="c1">#           SYSTEM CLOCK</span>
<span class="linenos"> 79</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="n">DEFAULT_SYS_CLK</span> <span class="o">=</span> <span class="mi">125_000_000</span>
<span class="linenos"> 82</span><span class="n">STABLE_OVERCLOCK</span> <span class="o">=</span> <span class="mi">270_000_000</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span><span class="c1"># Pico can go up to 270MHz before needing to flash to the eeprom directly.</span>
<span class="linenos"> 85</span><span class="n">system_clock</span> <span class="o">=</span> <span class="n">STABLE_OVERCLOCK</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="c1"># if the system clock is not the default, apply the clock speed.</span>
<span class="linenos"> 88</span><span class="k">if</span> <span class="n">system_clock</span> <span class="o">!=</span>  <span class="n">DEFAULT_SYS_CLK</span><span class="p">:</span>
<span class="linenos"> 89</span>    <span class="n">freq</span><span class="p">(</span><span class="n">system_clock</span><span class="p">)</span>
<span class="linenos"> 90</span>
<span class="linenos"> 91</span><span class="c1"># print(f&#39;Clock: {freq()/1e6}MHz&#39;)</span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 94</span><span class="c1">#               PINOUT</span>
<span class="linenos"> 95</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span><span class="c1"># LCD Pins handled in LCD.py</span>
<span class="linenos"> 98</span><span class="c1"># ----------------------------</span>
<span class="linenos"> 99</span><span class="c1"># EN = Pin(0, Pin.OUT)</span>
<span class="linenos">100</span><span class="c1"># RS = Pin(1, Pin.OUT)</span>
<span class="linenos">101</span><span class="c1"># D7 = Pin(2, Pin.OUT)</span>
<span class="linenos">102</span><span class="c1"># D6 = Pin(3, Pin.OUT)</span>
<span class="linenos">103</span><span class="c1"># D5 = Pin(4, Pin.OUT)</span>
<span class="linenos">104</span><span class="c1"># D4 = Pin(5, Pin.OUT)</span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="c1"># Ultrasonic sensor pins handled in sensors.py</span>
<span class="linenos">107</span><span class="c1"># ----------------------------</span>
<span class="linenos">108</span><span class="c1"># us0_trig = Pin(6, Pin.OUT)</span>
<span class="linenos">109</span><span class="c1"># us0_echo = Pin(7, Pin.IN)</span>
<span class="linenos">110</span><span class="c1"># us1_trig = Pin(8, Pin.OUT)</span>
<span class="linenos">111</span><span class="c1"># us1_echo = Pin(9, Pin.IN)</span>
<span class="linenos">112</span>
<span class="linenos">113</span><span class="c1"># Switches</span>
<span class="linenos">114</span><span class="c1"># ----------------------------</span>
<span class="linenos">115</span><span class="n">sw0</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">PULL_DOWN</span><span class="p">)</span>
<span class="linenos">116</span><span class="n">sw1</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">PULL_DOWN</span><span class="p">)</span>
<span class="linenos">117</span><span class="n">sw2</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">PULL_DOWN</span><span class="p">)</span>
<span class="linenos">118</span><span class="n">sw3</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">PULL_DOWN</span><span class="p">)</span>
<span class="linenos">119</span><span class="n">switch_pins</span> <span class="o">=</span> <span class="p">[</span><span class="n">sw0</span><span class="p">,</span> <span class="n">sw1</span><span class="p">,</span> <span class="n">sw2</span><span class="p">,</span> <span class="n">sw3</span><span class="p">]</span>
<span class="linenos">120</span>
<span class="linenos">121</span><span class="c1"># LEDs</span>
<span class="linenos">122</span><span class="c1"># ----------------------------</span>
<span class="linenos">123</span><span class="n">led0</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">124</span><span class="n">led1</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">125</span><span class="n">led_onboard</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">126</span><span class="n">led_pins</span> <span class="o">=</span> <span class="p">[</span><span class="n">led0</span><span class="p">,</span> <span class="n">led1</span><span class="p">,</span> <span class="n">led_onboard</span><span class="p">]</span>
<span class="linenos">127</span>
<span class="linenos">128</span><span class="c1"># SPI handled by the Hardware in spi_config.py</span>
<span class="linenos">129</span><span class="c1"># ----------------------------</span>
<span class="linenos">130</span><span class="c1"># miso = Pin(16, Pin.IN)</span>
<span class="linenos">131</span><span class="c1"># cs = Pin(17, Pin.OUT, value=1)</span>
<span class="linenos">132</span><span class="c1"># mosi = Pin(18, Pin.OUT)</span>
<span class="linenos">133</span><span class="c1"># sck = Pin(19, Pin.OUT)</span>
<span class="linenos">134</span>
<span class="linenos">135</span><span class="c1"># Buttons</span>
<span class="linenos">136</span><span class="c1"># ----------------------------</span>
<span class="linenos">137</span><span class="n">button0</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
<span class="linenos">138</span><span class="n">button1</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
<span class="linenos">139</span><span class="n">button2</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
<span class="linenos">140</span><span class="n">button3</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
<span class="linenos">141</span><span class="n">button_pins</span> <span class="o">=</span> <span class="p">[</span><span class="n">button0</span><span class="p">,</span> <span class="n">button1</span><span class="p">,</span> <span class="n">button2</span><span class="p">,</span> <span class="n">button3</span><span class="p">]</span>
<span class="linenos">142</span>
<span class="linenos">143</span><span class="c1"># ADC</span>
<span class="linenos">144</span><span class="c1"># ----------------------------</span>
<span class="linenos">145</span><span class="c1"># adc0 = ADC(26) # Connect to GP26, which is channel 0</span>
<span class="linenos">146</span><span class="c1"># adc1 = ADC(27) # Connect to GP27, which is channel 1</span>
<span class="linenos">147</span>
<span class="linenos">148</span>
<span class="linenos">149</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">150</span><span class="c1">#           GENERAL I/O </span>
<span class="linenos">151</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">152</span><span class="n">last_time</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">153</span><span class="k">def</span> <span class="nf">debounce</span><span class="p">():</span>
<span class="linenos">154</span>    <span class="k">global</span> <span class="n">last_time</span>
<span class="linenos">155</span>    <span class="n">new_time</span> <span class="o">=</span> <span class="n">ticks_ms</span><span class="p">()</span>
<span class="linenos">156</span>    <span class="c1"># if it has been more that 1/10 of a second since the last event, we have a new event</span>
<span class="linenos">157</span>    <span class="k">if</span> <span class="p">(</span><span class="n">new_time</span> <span class="o">-</span> <span class="n">last_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span> 
<span class="linenos">158</span>        <span class="n">last_time</span> <span class="o">=</span> <span class="n">new_time</span>
<span class="linenos">159</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">160</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">161</span>        <span class="k">return</span> <span class="kc">False</span>
<span class="linenos">162</span>
<span class="linenos">163</span><span class="k">def</span> <span class="nf">button0_irq_handler</span><span class="p">(</span><span class="n">pin</span><span class="p">):</span>
<span class="linenos">164</span>    <span class="k">global</span> <span class="n">reset</span>
<span class="linenos">165</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debounce</span><span class="p">()):</span>
<span class="linenos">166</span>        <span class="n">reset</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">167</span>
<span class="linenos">168</span><span class="k">def</span> <span class="nf">button1_irq_handler</span><span class="p">(</span><span class="n">pin</span><span class="p">):</span>
<span class="linenos">169</span>    <span class="k">global</span> <span class="n">menu_select</span>
<span class="linenos">170</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debounce</span><span class="p">()):</span>
<span class="linenos">171</span>        <span class="n">menu_select</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">172</span>
<span class="linenos">173</span><span class="k">def</span> <span class="nf">button2_irq_handler</span><span class="p">(</span><span class="n">pin</span><span class="p">):</span>
<span class="linenos">174</span>    <span class="k">global</span> <span class="n">menu_select</span>
<span class="linenos">175</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debounce</span><span class="p">()):</span>
<span class="linenos">176</span>        <span class="n">menu_select</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">177</span>
<span class="linenos">178</span><span class="k">def</span> <span class="nf">button3_irq_handler</span><span class="p">(</span><span class="n">pin</span><span class="p">):</span>
<span class="linenos">179</span>    <span class="k">global</span> <span class="n">menu_select</span>
<span class="linenos">180</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debounce</span><span class="p">()):</span>
<span class="linenos">181</span>        <span class="n">menu_select</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos">182</span>
<span class="linenos">183</span><span class="c1"># now we register the handler function when the button is pressed</span>
<span class="linenos">184</span><span class="n">button0</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="n">Pin</span><span class="o">.</span><span class="n">IRQ_RISING</span><span class="p">,</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">button0_irq_handler</span><span class="p">)</span>
<span class="linenos">185</span><span class="n">button1</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="n">Pin</span><span class="o">.</span><span class="n">IRQ_RISING</span><span class="p">,</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">button1_irq_handler</span><span class="p">)</span>
<span class="linenos">186</span><span class="n">button2</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="n">Pin</span><span class="o">.</span><span class="n">IRQ_RISING</span><span class="p">,</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">button2_irq_handler</span><span class="p">)</span>
<span class="linenos">187</span><span class="n">button3</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="n">Pin</span><span class="o">.</span><span class="n">IRQ_RISING</span><span class="p">,</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">button3_irq_handler</span><span class="p">)</span>
<span class="linenos">188</span>
<span class="linenos">189</span>
<span class="linenos">190</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">191</span><span class="c1">#           ULTRASONIC SENSORS</span>
<span class="linenos">192</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">193</span>
<span class="linenos">194</span>
<span class="linenos">195</span><span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">Pin</span>
<span class="linenos">196</span><span class="kn">from</span> <span class="nn">utime</span> <span class="kn">import</span> <span class="n">ticks_us</span><span class="p">,</span> <span class="n">sleep_us</span>
<span class="linenos">197</span>
<span class="linenos">198</span><span class="c1"># Ultrasonic sensor pins</span>
<span class="linenos">199</span><span class="c1"># ----------------------------</span>
<span class="linenos">200</span><span class="n">us0_trig</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">201</span><span class="n">us0_echo</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
<span class="linenos">202</span><span class="n">us1_trig</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">203</span><span class="n">us1_echo</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
<span class="linenos">204</span>
<span class="linenos">205</span><span class="k">def</span> <span class="nf">get_distance_u0</span><span class="p">():</span>
<span class="linenos">206</span>
<span class="linenos">207</span>    <span class="c1"># send the trigger wave</span>
<span class="linenos">208</span>    <span class="n">us0_trig</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">209</span>    <span class="n">sleep_us</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">210</span>    <span class="n">us0_trig</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">211</span>    
<span class="linenos">212</span>    <span class="c1"># listen for the return echo</span>
<span class="linenos">213</span>    <span class="k">while</span> <span class="n">us0_echo</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">214</span>        <span class="n">start</span> <span class="o">=</span> <span class="n">ticks_us</span><span class="p">()</span>
<span class="linenos">215</span>    <span class="k">while</span> <span class="n">us0_echo</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">216</span>        <span class="n">stop</span> <span class="o">=</span> <span class="n">ticks_us</span><span class="p">()</span>
<span class="linenos">217</span>
<span class="linenos">218</span>    <span class="k">return</span> <span class="p">((</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0343</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">219</span>
<span class="linenos">220</span><span class="k">def</span> <span class="nf">get_distance_u1</span><span class="p">():</span>
<span class="linenos">221</span>    <span class="k">global</span> <span class="n">us1_distance</span>
<span class="linenos">222</span>
<span class="linenos">223</span>    <span class="c1"># send the trigger wave</span>
<span class="linenos">224</span>    <span class="n">us1_trig</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">225</span>    <span class="n">sleep_us</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">226</span>    <span class="n">us1_trig</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">227</span>    
<span class="linenos">228</span>    <span class="c1"># listen for the return echo</span>
<span class="linenos">229</span>    <span class="k">while</span> <span class="n">us1_echo</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">230</span>        <span class="n">start</span> <span class="o">=</span> <span class="n">ticks_us</span><span class="p">()</span>
<span class="linenos">231</span>    <span class="k">while</span> <span class="n">us1_echo</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">232</span>        <span class="n">stop</span> <span class="o">=</span> <span class="n">ticks_us</span><span class="p">()</span>
<span class="linenos">233</span>
<span class="linenos">234</span>    <span class="k">return</span> <span class="p">((</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0343</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">235</span>
<span class="linenos">236</span>
<span class="linenos">237</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">238</span><span class="c1">#           LCD</span>
<span class="linenos">239</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">240</span><span class="n">lcd_init</span><span class="p">()</span>
<span class="linenos">241</span><span class="n">lcd_clear</span><span class="p">()</span>
<span class="linenos">242</span><span class="c1"># lcd_cursor_on()</span>
<span class="linenos">243</span><span class="c1"># lcd_cursor_blink()</span>
<span class="linenos">244</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">245</span><span class="c1">#           ADC</span>
<span class="linenos">246</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">247</span><span class="n">adc0</span> <span class="o">=</span> <span class="n">ADC</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span> <span class="c1"># Connect to GP26, which is channel 0</span>
<span class="linenos">248</span><span class="n">adc1</span> <span class="o">=</span> <span class="n">ADC</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="c1"># Connect to GP27, which is channel 1</span>
<span class="linenos">249</span><span class="c1"># adc2 = machine.ADC(28) # Connect to GP28, which is channel 2</span>
<span class="linenos">250</span><span class="c1"># adc_reading = adc0.read_u16() * VOLT_PER_BIT # read and report the ADC reading</span>
<span class="linenos">251</span>
<span class="linenos">252</span>
<span class="linenos">253</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">254</span><span class="c1">#           DAC</span>
<span class="linenos">255</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">256</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">257</span><span class="n">selected_wave</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">258</span>
<span class="linenos">259</span>
<span class="linenos">260</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">261</span><span class="c1">#           TIMERS</span>
<span class="linenos">262</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">263</span><span class="n">spi_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
<span class="linenos">264</span>
<span class="linenos">265</span><span class="k">def</span> <span class="nf">spi_timer_tick</span><span class="p">(</span><span class="n">timer</span><span class="p">):</span>
<span class="linenos">266</span>    <span class="sd">&quot;&quot;&quot;Process that sends waveform data to the DAC via SPI&quot;&quot;&quot;</span>
<span class="linenos">267</span><span class="c1">#     spi_timer.init(freq=frequency*selected_wave.size, mode=Timer.PERIODIC, callback=spi_timer_tick)</span>
<span class="linenos">268</span>
<span class="linenos">269</span>    <span class="k">global</span> <span class="n">frequency</span>
<span class="linenos">270</span>    <span class="k">global</span> <span class="n">amplitude</span>
<span class="linenos">271</span>    <span class="k">global</span> <span class="n">selected_wave</span>
<span class="linenos">272</span>    <span class="k">global</span> <span class="n">index</span>
<span class="linenos">273</span>    <span class="k">global</span> <span class="n">cs</span>
<span class="linenos">274</span>
<span class="linenos">275</span>    <span class="k">if</span> <span class="n">selected_wave</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">276</span>    
<span class="linenos">277</span>        <span class="c1"># output the waveform to DAC via SPI  </span>
<span class="linenos">278</span>                
<span class="linenos">279</span>        <span class="c1"># complete math for the value that we send to the DAC</span>
<span class="linenos">280</span>        <span class="n">dac_output</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">selected_wave</span><span class="o">.</span><span class="n">lut</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">amplitude</span> <span class="o">/</span> <span class="n">AMP_MAX</span><span class="p">))</span> <span class="o">+</span> <span class="n">DC_OFFSET_RES</span><span class="p">)</span>
<span class="linenos">281</span>        
<span class="linenos">282</span>        <span class="c1"># bit shift so the value is acceptable by the 10 bit DAC</span>
<span class="linenos">283</span>        
<span class="linenos">284</span>        <span class="c1"># A3 A2 A1 A0 D10 D9 D8 D7 D6 D5 D4 D3 D2 D1 D0 X1 X0</span>
<span class="linenos">285</span>        <span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x9</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dac_output</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos">286</span>        <span class="n">format_array</span> <span class="o">=</span> <span class="p">[((</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">),</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)]</span>
<span class="linenos">287</span>        <span class="n">write_array</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">format_array</span><span class="p">)</span>
<span class="linenos">288</span>
<span class="linenos">289</span>        <span class="c1"># write to the device</span>
<span class="linenos">290</span>        <span class="n">cs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">291</span>        <span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_array</span><span class="p">)</span>
<span class="linenos">292</span>        <span class="n">cs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">293</span>                
<span class="linenos">294</span>        <span class="c1"># iterate through the waveform tables.</span>
<span class="linenos">295</span>        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">296</span>        <span class="n">index</span> <span class="o">&amp;=</span> <span class="n">selected_wave</span><span class="o">.</span><span class="n">last_index</span>
<span class="linenos">297</span>
<span class="linenos">298</span>
<span class="linenos">299</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">300</span><span class="c1">#           PROCESS 1: IO</span>
<span class="linenos">301</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">302</span>
<span class="linenos">303</span>
<span class="linenos">304</span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">305</span>
<span class="linenos">306</span>    <span class="n">splash</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">307</span>    <span class="c1"># Display the splash screen on startup.</span>
<span class="linenos">308</span>    <span class="k">if</span> <span class="n">splash</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">309</span>        <span class="n">led0</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">310</span>        <span class="n">led1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">311</span>        <span class="n">led_onboard</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">312</span>        <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;USonic Theremin  &#39;</span><span class="p">)</span>
<span class="linenos">313</span>        <span class="n">lcd_goto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">314</span>        <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dieter S.        &#39;</span><span class="p">)</span>
<span class="linenos">315</span>        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">316</span>        <span class="n">lcd_home</span><span class="p">()</span>
<span class="linenos">317</span>        <span class="n">lcd_clear</span><span class="p">()</span>
<span class="linenos">318</span>        <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;System Clock&#39;</span><span class="p">)</span>
<span class="linenos">319</span>        <span class="n">lcd_goto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">320</span>        <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">freq</span><span class="p">()</span><span class="o">/</span><span class="mf">1e6</span><span class="si">}</span><span class="s1">MHz&#39;</span><span class="p">)</span>
<span class="linenos">321</span>        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">322</span>        <span class="n">lcd_home</span><span class="p">()</span>
<span class="linenos">323</span>        <span class="n">lcd_clear</span><span class="p">()</span>
<span class="linenos">324</span>        <span class="n">led0</span><span class="o">.</span><span class="n">toggle</span><span class="p">()</span>
<span class="linenos">325</span>        <span class="n">led1</span><span class="o">.</span><span class="n">toggle</span><span class="p">()</span>
<span class="linenos">326</span>        <span class="n">led_onboard</span><span class="o">.</span><span class="n">toggle</span><span class="p">()</span>
<span class="linenos">327</span>
<span class="linenos">328</span>    <span class="c1"># Start timers and threads </span>
<span class="linenos">329</span>    <span class="n">reset</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">330</span>    <span class="n">menu_select</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">331</span>    <span class="n">saved_frequency</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">332</span>    <span class="n">frequency</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">333</span>    <span class="n">amplitude</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">334</span>    <span class="n">freq_min</span> <span class="o">=</span> <span class="n">FREQ_MIN</span>
<span class="linenos">335</span>    <span class="n">freq_max</span> <span class="o">=</span> <span class="n">FREQ_MAX</span>
<span class="linenos">336</span>    <span class="n">amp_max</span> <span class="o">=</span> <span class="n">AMP_MAX</span>
<span class="linenos">337</span>    <span class="n">amp_min</span> <span class="o">=</span> <span class="n">AMP_MIN</span>
<span class="linenos">338</span>
<span class="linenos">339</span>    <span class="c1"># -----------------------------------------</span>
<span class="linenos">340</span>    <span class="c1">#           Core Loop with reset</span>
<span class="linenos">341</span>    <span class="c1"># -----------------------------------------</span>
<span class="linenos">342</span>    <span class="k">while</span> <span class="n">reset</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
<span class="linenos">343</span>    
<span class="linenos">344</span>
<span class="linenos">345</span>        <span class="c1"># read ADC rotary controls</span>
<span class="linenos">346</span>        <span class="c1"># -----------------------------------------</span>
<span class="linenos">347</span>        <span class="n">adc0_reading</span> <span class="o">=</span> <span class="mf">3.3</span> <span class="o">-</span> <span class="p">(</span><span class="n">adc0</span><span class="o">.</span><span class="n">read_u16</span><span class="p">()</span> <span class="o">*</span> <span class="n">VOLT_PER_BIT</span><span class="p">)</span>
<span class="linenos">348</span>        <span class="n">adc1_reading</span> <span class="o">=</span> <span class="mf">3.3</span> <span class="o">-</span> <span class="p">(</span><span class="n">adc1</span><span class="o">.</span><span class="n">read_u16</span><span class="p">()</span> <span class="o">*</span> <span class="n">VOLT_PER_BIT</span><span class="p">)</span>
<span class="linenos">349</span>        <span class="c1"># print(f&#39;ADC0: {adc0_reading}&#39;)</span>
<span class="linenos">350</span>        <span class="c1"># print(f&#39;ADC1: {adc1_reading}&#39;)</span>
<span class="linenos">351</span>        
<span class="linenos">352</span>        <span class="c1"># Read Ultrasonic Sensors</span>
<span class="linenos">353</span>        <span class="c1"># -----------------------------------------</span>
<span class="linenos">354</span>        <span class="n">us0_distance</span> <span class="o">=</span> <span class="n">get_distance_u0</span><span class="p">()</span>
<span class="linenos">355</span>        <span class="n">us1_distance</span> <span class="o">=</span> <span class="n">get_distance_u1</span><span class="p">()</span>
<span class="linenos">356</span>        <span class="c1"># print(f&#39;US0: {us0_distance}&#39;)</span>
<span class="linenos">357</span>        <span class="c1"># print(f&#39;US1: {us1_distance}&#39;)</span>
<span class="linenos">358</span>        
<span class="linenos">359</span>        <span class="c1"># read switch controls and get selected wave</span>
<span class="linenos">360</span>        <span class="c1"># -----------------------------------------</span>
<span class="linenos">361</span>        <span class="n">switch_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">362</span>        <span class="k">for</span> <span class="n">switch</span> <span class="ow">in</span> <span class="n">switch_pins</span><span class="p">:</span>
<span class="linenos">363</span>            <span class="n">switch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">switch</span><span class="p">())</span> <span class="c1"># read switch and put val in list</span>
<span class="linenos">364</span>        
<span class="linenos">365</span>        <span class="k">if</span> <span class="n">switch_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># if none of the switches are high.</span>
<span class="linenos">366</span>            <span class="n">selected_wave</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">367</span>            
<span class="linenos">368</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">369</span>            <span class="n">switch_key</span> <span class="o">=</span> <span class="s2">&quot;SW&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">switch_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">370</span>            <span class="n">selected_wave</span> <span class="o">=</span> <span class="n">waveforms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">switch_key</span><span class="p">)</span>
<span class="linenos">371</span>        
<span class="linenos">372</span>        <span class="c1"># MENU LOGIC</span>
<span class="linenos">373</span>        <span class="c1"># -----------------------------------------</span>
<span class="linenos">374</span>        
<span class="linenos">375</span>        <span class="k">if</span> <span class="n">menu_select</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Default Menu, Show wave and frequency</span>
<span class="linenos">376</span>            
<span class="linenos">377</span>            <span class="n">wave_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Wave: None      &#39;</span> <span class="k">if</span> <span class="n">selected_wave</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;Wave: </span><span class="si">{</span><span class="n">selected_wave</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="linenos">378</span>            
<span class="linenos">379</span>            <span class="c1"># display the current waveform and frequency</span>
<span class="linenos">380</span>            <span class="c1"># -----------------------------------------</span>
<span class="linenos">381</span>            <span class="n">lcd_puts</span><span class="p">(</span><span class="n">wave_str</span><span class="p">)</span>
<span class="linenos">382</span>            <span class="n">lcd_goto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">383</span>            <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;F: </span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s1">Hz A: </span><span class="si">{</span><span class="n">amplitude</span><span class="si">}</span><span class="s1">V      &#39;</span><span class="p">)</span>
<span class="linenos">384</span>            <span class="n">lcd_home</span><span class="p">()</span>
<span class="linenos">385</span>            
<span class="linenos">386</span>        <span class="k">elif</span> <span class="n">menu_select</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Change range of waveform frequency</span>
<span class="linenos">387</span>            
<span class="linenos">388</span>            <span class="n">freq_min</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">FREQ_MAX</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">adc0_reading</span> <span class="o">/</span> <span class="n">ADC_REF</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">389</span>            <span class="n">freq_max</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">FREQ_MAX</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">adc1_reading</span> <span class="o">/</span> <span class="n">ADC_REF</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">390</span>            
<span class="linenos">391</span>            <span class="c1"># display the upper bound and lower bound</span>
<span class="linenos">392</span>            <span class="c1"># -----------------------------------------</span>
<span class="linenos">393</span>            <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Upper: </span><span class="si">{</span><span class="n">freq_max</span><span class="si">}</span><span class="s1">Hz     &#39;</span><span class="p">)</span>
<span class="linenos">394</span>            <span class="n">lcd_goto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">395</span>            <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Lower: </span><span class="si">{</span><span class="n">freq_min</span><span class="si">}</span><span class="s1">Hz     &#39;</span><span class="p">)</span>
<span class="linenos">396</span>            <span class="n">lcd_home</span><span class="p">()</span>
<span class="linenos">397</span>            
<span class="linenos">398</span>        <span class="k">elif</span> <span class="n">menu_select</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">399</span>            
<span class="linenos">400</span>            <span class="n">amp_min</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">AMP_MAX</span> <span class="o">*</span> <span class="p">(</span><span class="n">adc0_reading</span> <span class="o">/</span> <span class="n">ADC_REF</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">401</span>            <span class="n">amp_max</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">AMP_MAX</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">adc1_reading</span> <span class="o">/</span> <span class="n">ADC_REF</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">402</span>            
<span class="linenos">403</span>            <span class="c1"># display the upper bound and lower bound</span>
<span class="linenos">404</span>            <span class="c1"># -----------------------------------------</span>
<span class="linenos">405</span>            <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Upper: </span><span class="si">{</span><span class="n">amp_max</span><span class="si">}</span><span class="s1">V     &#39;</span><span class="p">)</span>
<span class="linenos">406</span>            <span class="n">lcd_goto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">407</span>            <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Lower: </span><span class="si">{</span><span class="n">amp_min</span><span class="si">}</span><span class="s1">V     &#39;</span><span class="p">)</span>
<span class="linenos">408</span>            <span class="n">lcd_home</span><span class="p">()</span>                
<span class="linenos">409</span>            
<span class="linenos">410</span>            
<span class="linenos">411</span>        <span class="c1"># Dual Core Interaction</span>
<span class="linenos">412</span>        <span class="c1"># -----------------------------------------</span>
<span class="linenos">413</span>        
<span class="linenos">414</span>        <span class="c1">#  out of range, stop the waveform process.</span>
<span class="linenos">415</span>        <span class="k">if</span> <span class="n">us1_distance</span> <span class="o">&gt;</span> <span class="n">MAX_DIST_US1</span> <span class="ow">or</span> <span class="n">us0_distance</span> <span class="o">&gt;</span> <span class="n">MAX_DIST_US0</span><span class="p">:</span>
<span class="linenos">416</span>            <span class="c1"># spi_timer.deinit()</span>
<span class="linenos">417</span>            <span class="n">frequency</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">418</span>            <span class="n">amplitude</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">419</span>            
<span class="linenos">420</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">421</span>            <span class="n">frequency</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(((</span><span class="n">freq_max</span> <span class="o">-</span> <span class="n">freq_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">MAX_DIST_US0</span> <span class="o">-</span> <span class="n">us0_distance</span><span class="p">)</span> <span class="o">/</span> <span class="n">MAX_DIST_US0</span><span class="p">))</span> <span class="o">+</span> <span class="n">freq_min</span><span class="p">)</span>
<span class="linenos">422</span>            <span class="n">amplitude</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(((</span><span class="n">amp_max</span> <span class="o">-</span> <span class="n">amp_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">MAX_DIST_US1</span> <span class="o">-</span> <span class="n">us1_distance</span><span class="p">)</span> <span class="o">/</span> <span class="n">MAX_DIST_US1</span><span class="p">))</span> <span class="o">+</span> <span class="n">amp_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">423</span>        
<span class="linenos">424</span>            <span class="k">if</span> <span class="n">selected_wave</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">425</span>                <span class="n">spi_timer</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">frequency</span><span class="o">*</span><span class="n">selected_wave</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">Timer</span><span class="o">.</span><span class="n">PERIODIC</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">spi_timer_tick</span><span class="p">)</span>
<span class="linenos">426</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">427</span>                <span class="n">spi_timer</span><span class="o">.</span><span class="n">deinit</span><span class="p">()</span>
<span class="linenos">428</span>        
<span class="linenos">429</span>        <span class="c1"># toggle onboard LED for System speed status and refresh delay</span>
<span class="linenos">430</span>        <span class="c1"># -----------------------------------------</span>
<span class="linenos">431</span>        <span class="n">led_onboard</span><span class="o">.</span><span class="n">toggle</span><span class="p">()</span>
<span class="linenos">432</span>        <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="n">REFRESH_PERIOD</span><span class="p">)</span>
<span class="linenos">433</span>        
<span class="linenos">434</span>    <span class="n">spi_timer</span><span class="o">.</span><span class="n">deinit</span><span class="p">()</span>
<span class="linenos">435</span>  
<span class="linenos">436</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">437</span><span class="c1">#     PROCESS 2: Waveform Generation</span>
<span class="linenos">438</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">439</span>
<span class="linenos">440</span><span class="c1"># while True:</span>
<span class="linenos">441</span><span class="c1">#     if frequency != 0:</span>
<span class="linenos">442</span><span class="c1">#         </span>
<span class="linenos">443</span><span class="c1">#         if frequency != saved_frequency and selected_wave is not None:  </span>
<span class="linenos">444</span><span class="c1">#          spi_timer.init(freq=frequency*selected_wave.size, mode=Timer.PERIODIC, callback=spi_timer_tick)</span>
<span class="linenos">445</span><span class="c1">#          saved_frequency = frequency</span>
<span class="linenos">446</span><span class="c1">#          </span>
<span class="linenos">447</span><span class="c1">#     else:</span>
<span class="linenos">448</span><span class="c1">#         spi_timer.deinit()</span>
<span class="linenos">449</span><span class="c1"># </span>
<span class="linenos">450</span><span class="c1">#     </span>
<span class="linenos">451</span>    
<span class="linenos">452</span>    
<span class="linenos">453</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">454</span><span class="c1">#           END OF FILE</span>
<span class="linenos">455</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">456</span>
<span class="linenos">457</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline"></a></h2>
<dl class="footnote brackets">
<dt class="label" id="id45"><span class="brackets">1</span><span class="fn-backref">(<a href="#id20">1</a>,<a href="#id21">2</a>,<a href="#id22">3</a>,<a href="#id26">4</a>)</span></dt>
<dd><p>A. S. Sedra, K. C. Smith, T. C. Carusone, and V. Gaudet, “Chapter 2: Operational
Amplifiers,” in Microelectronic circuits, New York, NY: Oxford University Press, 2021,
pp. 60–73.</p>
</dd>
<dt class="label" id="id46"><span class="brackets">2</span><span class="fn-backref">(<a href="#id30">1</a>,<a href="#id42">2</a>)</span></dt>
<dd><p>“What is a bypass capacitor? tutorial: Applications,” Electronics Hub, 14-Sep-2021.
[Online]. Available: <a class="reference external" href="https://www.electronicshub.org/bypass-capacitor-tutorial/">https://www.electronicshub.org/bypass-capacitor-tutorial/</a>. [Accessed:
27-Aug-2022].</p>
</dd>
<dt class="label" id="id47"><span class="brackets">3</span><span class="fn-backref">(<a href="#id4">1</a>,<a href="#id12">2</a>)</span></dt>
<dd><p>“Analog-to-digital converter,” Wikipedia, 09-Oct-2022. [Online]. Available:
<a class="reference external" href="https://en.wikipedia.org/wiki/Analog-to-digital_converter">https://en.wikipedia.org/wiki/Analog-to-digital_converter</a>. [Accessed: 19-Oct-2022].</p>
</dd>
<dt class="label" id="id48"><span class="brackets">4</span><span class="fn-backref">(<a href="#id31">1</a>,<a href="#id44">2</a>)</span></dt>
<dd><p>“Decoupling capacitors and bypass capacitors – working, applications and differences,”
Components101. [Online]. Available: <a class="reference external" href="https://components101.com/articles/decouplingcapacitor-vs-bypass-capacitors-working-and-applications">https://components101.com/articles/decouplingcapacitor-vs-bypass-capacitors-working-and-applications</a>. [Accessed: 27-Aug-2022].</p>
</dd>
<dt class="label" id="id49"><span class="brackets">5</span><span class="fn-backref">(<a href="#id8">1</a>,<a href="#id9">2</a>,<a href="#id10">3</a>,<a href="#id11">4</a>)</span></dt>
<dd><p>“Digital-to-analog converter,” Wikipedia, 13-Jun-2022. [Online]. Available:
<a class="reference external" href="https://en.wikipedia.org/wiki/Digital-to-analog_converter">https://en.wikipedia.org/wiki/Digital-to-analog_converter</a>. [Accessed: 19-Oct-2022].</p>
</dd>
<dt class="label" id="id50"><span class="brackets">6</span></dt>
<dd><p>“FilterPro™ user’s Guide - Ti.com,” Texas Instruments, Feb-2011. [Online]. Available:
<a class="reference external" href="https://www.ti.com/lit/an/sbfa001b/sbfa001b.pdf">https://www.ti.com/lit/an/sbfa001b/sbfa001b.pdf</a>. [Accessed: 14-Nov-2022].</p>
</dd>
<dt class="label" id="id51"><span class="brackets"><a class="fn-backref" href="#id23">7</a></span></dt>
<dd><p>H. Zumbahlen, “Chapter 8: Analog Filters,” in Linear Circuit Design Handbook, Oxford:
Newnes, 2008.</p>
</dd>
<dt class="label" id="id52"><span class="brackets">8</span><span class="fn-backref">(<a href="#id37">1</a>,<a href="#id38">2</a>)</span></dt>
<dd><p>“HC-SR04 User Manual,” Scribd. [Online]. Available:
<a class="reference external" href="https://www.scribd.com/document/363064776/HC-SR04-User-Manual">https://www.scribd.com/document/363064776/HC-SR04-User-Manual</a>. [Accessed: 14-
Nov-2022].</p>
</dd>
<dt class="label" id="id53"><span class="brackets">9</span><span class="fn-backref">(<a href="#id24">1</a>,<a href="#id25">2</a>)</span></dt>
<dd><p>I. Poole, “OP AMP frequency response &amp; gain bandwidth product,” Electronics Notes, 30-
Nov-2021. [Online]. Available: <a class="reference external" href="https://www.electronicsnotes.com/articles/analogue_circuits/operational-amplifier-op-amp/gain-bandwidthproduct-frequency-response.php">https://www.electronicsnotes.com/articles/analogue_circuits/operational-amplifier-op-amp/gain-bandwidthproduct-frequency-response.php</a>. [Accessed: 31-Oct-2022].</p>
</dd>
<dt class="label" id="id54"><span class="brackets">10</span><span class="fn-backref">(<a href="#id29">1</a>,<a href="#id33">2</a>,<a href="#id36">3</a>)</span></dt>
<dd><p>“LM2940x 1-a low dropout regulator datasheet (rev. J) -Texas Instruments,” Texas
Instruments. [Online]. Available:
<a class="reference external" href="https://www.ti.com/general/docs/lit/getliterature.tsp?genericPartNumber=LM2940C&amp;fileType=pdf&amp;HQS=ti-null-null-alldatasheets-df-ds-null-wwe&amp;DCM=yes">https://www.ti.com/general/docs/lit/getliterature.tsp?genericPartNumber=LM2940C&amp;fileType=pdf&amp;HQS=ti-null-null-alldatasheets-df-ds-null-wwe&amp;DCM=yes</a>. [Accessed: 14-Nov2022].</p>
</dd>
<dt class="label" id="id55"><span class="brackets">11</span><span class="fn-backref">(<a href="#id27">1</a>,<a href="#id28">2</a>)</span></dt>
<dd><p>“LM386,” LM386 data sheet, product information and support | TI.com. [Online].
Available: <a class="reference external" href="https://www.ti.com/product/LM386">https://www.ti.com/product/LM386</a>. [Accessed: 30-Oct-2022].</p>
</dd>
<dt class="label" id="id56"><span class="brackets">12</span><span class="fn-backref">(<a href="#id15">1</a>,<a href="#id17">2</a>,<a href="#id18">3</a>,<a href="#id19">4</a>)</span></dt>
<dd><p>“Ltc1661 – micropower dual 10-bit DAC in MSOP - Analog Devices.” [Online]. Available:
<a class="reference external" href="https://www.analog.com/media/en/technical-documentation/data-sheets/1661fb.pdf">https://www.analog.com/media/en/technical-documentation/data-sheets/1661fb.pdf</a>.
[Accessed: 17-Oct-2022].</p>
</dd>
<dt class="label" id="id57"><span class="brackets">13</span><span class="fn-backref">(<a href="#id41">1</a>,<a href="#id43">2</a>)</span></dt>
<dd><p>M. Stapleton, “Altium Designer 20 Video Series,” YouTube, 2021. [Online]. Available:
<a class="reference external" href="https://www.youtube.com/channel/UCutfTyfmz-WB2hYA03RRN5A/featured">https://www.youtube.com/channel/UCutfTyfmz-WB2hYA03RRN5A/featured</a>. [Accessed:
27-Aug-2022].</p>
</dd>
<dt class="label" id="id58"><span class="brackets"><a class="fn-backref" href="#id14">14</a></span></dt>
<dd><p>“MicroPython documentation,” Overview - MicroPython 1.19.1 documentation, 14-Oct2022. [Online]. Available: <a class="reference external" href="https://docs.micropython.org/en/latest/">https://docs.micropython.org/en/latest/</a>. [Accessed: 19-Oct2022].</p>
</dd>
<dt class="label" id="id59"><span class="brackets">15</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id3">2</a>,<a href="#id6">3</a>,<a href="#id16">4</a>,<a href="#id34">5</a>)</span></dt>
<dd><p>“Raspberry Pico Datasheet,” raspberrypi.com. [Online]. Available:
<a class="reference external" href="https://datasheets.raspberrypi.com/pico/pico-datasheet.pdf">https://datasheets.raspberrypi.com/pico/pico-datasheet.pdf</a>. [Accessed: 15-Nov-2022].</p>
</dd>
<dt class="label" id="id60"><span class="brackets">16</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id5">2</a>,<a href="#id13">3</a>,<a href="#id35">4</a>)</span></dt>
<dd><p>“Raspberry Pico python SDK,” raspberrypi.com. [Online]. Available:
<a class="reference external" href="https://datasheets.raspberrypi.com/pico/raspberry-pi-pico-python-sdk.pdf">https://datasheets.raspberrypi.com/pico/raspberry-pi-pico-python-sdk.pdf</a>. [Accessed: 15-
Nov-2022].</p>
</dd>
<dt class="label" id="id61"><span class="brackets">17</span></dt>
<dd><p>“RP2040 Datasheet,” raspberrypi.com. [Online]. Available:
<a class="reference external" href="https://datasheets.raspberrypi.com/rp2040/rp2040-datasheet.pdf">https://datasheets.raspberrypi.com/rp2040/rp2040-datasheet.pdf</a>. [Accessed: 14-Nov-2022].</p>
</dd>
<dt class="label" id="id62"><span class="brackets"><a class="fn-backref" href="#id7">18</a></span></dt>
<dd><p>“Serial peripheral interface,” Wikipedia, 27-Sep-2022. [Online]. Available:
<a class="reference external" href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface">https://en.wikipedia.org/wiki/Serial_Peripheral_Interface</a>. [Accessed: 19-Oct-2022].</p>
</dd>
<dt class="label" id="id63"><span class="brackets">19</span><span class="fn-backref">(<a href="#id39">1</a>,<a href="#id40">2</a>)</span></dt>
<dd><p>“Sitronix ST7066U - Crystalfontz,” crystalfontz. [Online]. Available:
<a class="reference external" href="https://www.crystalfontz.com/controllers/Sitronix/ST7066U/438">https://www.crystalfontz.com/controllers/Sitronix/ST7066U/438</a>. [Accessed: 03-Oct2022].</p>
</dd>
<dt class="label" id="id64"><span class="brackets"><a class="fn-backref" href="#id32">20</a></span></dt>
<dd><p>“What is a Bypass Capacitor?,” What is a bypass capacitor? [Online]. Available:
<a class="reference external" href="http://www.learningaboutelectronics.com/Articles/What-is-a-bypass-capacitor.html">http://www.learningaboutelectronics.com/Articles/What-is-a-bypass-capacitor.html</a>.
[Accessed: 27-Aug-2022].</p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="condenser_microphone.html" class="btn btn-neutral float-left" title="Condenser Microphone Workshop" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Dieter Steinhauser.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>