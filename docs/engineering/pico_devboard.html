<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raspberry Pico Development board &mdash; Project Documentation 1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Linear Power Supply" href="linear_power_supply.html" />
    <link rel="prev" title="Ultrasonic Theremin - Junior Design" href="ultrasonic_theremin.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Project Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../rpi/rpi_projects.html">Raspberry Pi Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programming/programming_projects.html">Programming Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fun/fun_projects.html">Entertainment Projects</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="engineering_projects.html">Engineering Projects</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="condenser_microphone.html">Condenser Microphone Workshop</a></li>
<li class="toctree-l2"><a class="reference internal" href="ultrasonic_theremin.html">Ultrasonic Theremin - Junior Design</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Raspberry Pico Development board</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#methods">Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adc-configuration">ADC Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#power-regulation-and-filtering">Power Regulation and Filtering</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sd-card-reader">SD Card Reader</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inputs-and-outputs">Inputs and Outputs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#schematic-and-pcb-design">Schematic and PCB Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bill-of-materials">Bill Of Materials</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#results">Results</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#power">Power</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#appendix">Appendix</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#lcd-py">LCD.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sdcard-py">sdcard.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-py">test.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="linear_power_supply.html">Linear Power Supply</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="engineering_reference.html">Engineering Reference and Theory</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Project Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="engineering_projects.html">Engineering Projects</a> &raquo;</li>
      <li>Raspberry Pico Development board</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/engineering/pico_devboard.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="raspberry-pico-development-board">
<h1>Raspberry Pico Development board<a class="headerlink" href="#raspberry-pico-development-board" title="Permalink to this headline"></a></h1>
<p>Date: 12/2022</p>
<p>Revision: 1</p>
<figure class="align-center" id="id18">
<img alt="../_images/dev_board_assembled.jpg" src="../_images/dev_board_assembled.jpg" />
<figcaption>
<p><span class="caption-text">Figure 42: Raspberry Pico Development Board</span><a class="headerlink" href="#id18" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline"></a></h2>
<p>The Raspberry Pico is a powerful and inexpensive microcontroller that can be used for a variety of projects.
However, the Raspberry Pi Foundation prioritized factors of size, efficiency, and cost when creating the board.
This leaves certain drawbacks of the microcontroller that are well documented in the Pico datasheet <a class="footnote-reference brackets" href="#id14" id="id1">15</a>.
In this project, I aim to solve a few minor inconveniences of the Pico’s design and create a development board better
suited to approaching projects. Fixes include a reset button, an off switch for the onboard SMPS,
LDO voltage regulators, and better ADC performance. Additionally, Parallel 16x2 LCD display, two 10-bit DAC channels,
and SD card R/W capability are added to allow the development board to act as a drop in test bench for relaying or saving
information.</p>
</section>
<section id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this headline"></a></h2>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>This device focuses on ADCs, DACs, and displays to streamline development of a project.
Concepts and components from the pages below are employed. Topics that required greater detail for clarification
are revisited.</p>
<ul class="simple">
<li><p><a class="reference internal" href="raspberry_pico.html#raspberry-pico-microcontroller"><span class="std std-ref">Raspberry Pico Microcontroller</span></a></p></li>
<li><p><a class="reference internal" href="data_conversion.html#data-conversion-adc-and-dac-theory"><span class="std std-ref">Data Conversion: ADC and DAC Theory</span></a></p></li>
<li><p><a class="reference internal" href="communication_protocols.html#communication-protocols"><span class="std std-ref">Communication Protocols</span></a></p></li>
<li><p><a class="reference internal" href="ltc1661_dac.html#ltc1661-dac"><span class="std std-ref">LTC1661 DAC</span></a></p></li>
<li><p><a class="reference internal" href="lcd_16x2.html#x2-lcd-display"><span class="std std-ref">16x2 LCD Display</span></a></p></li>
</ul>
</div>
<section id="adc-configuration">
<h3>ADC Configuration<a class="headerlink" href="#adc-configuration" title="Permalink to this headline"></a></h3>
<p>Since the ADC in on the Raspberry Pico, initial setup of the ADC can easily be achieved
using the ADC section of the Pico Software Development Kit (SDK) <a class="footnote-reference brackets" href="#id13" id="id2">14</a>. This provides the
engineer with a simple and straightforward introduction on taking ADC readings. However, the
12-bit ADC onboard the Pico is not great by any means. This is due to the switching power
regulator on the Pico. As a result of switching signal noise, the onboard voltage reference for the
ADC is setup in poor conditions. The ADC has a 30mV offset and its signal is quite noisy <a class="footnote-reference brackets" href="#id12" id="id3">13</a>.
The datasheet gives suggestions on improvement of the ADC readings. An External reference
voltage may be used, the R7 resistor can be removed, or issues can be mitigated in averaging and
offset code. I chose a different route entirely, by adding bypass capacitors to the reference
voltage and ADC input pins for filtering and smoothing.</p>
<figure class="align-center" id="id19">
<img alt="../_images/adc_ref.png" src="../_images/adc_ref.png" />
<figcaption>
<p><span class="caption-text">Figure 18: Pico ADC reference circuit <a class="footnote-reference brackets" href="#id12" id="id4">13</a>.</span><a class="headerlink" href="#id19" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>The Approach taken in this circuit was to provide an external power source and bypass the SMPS entirely. By incorporating
a series of LDO’s we are able to create 5V and 3.3V rails with minimal noise. Driving the Pico via a 3.3V LDO feeds
the ADC reference through a lowpass filter onboard. This creates a significant improvement from ADC SMPS measurements.
However, since the entire Pico is supplied through the LDO 3.3V rail, voltage spikes and drops may occur from computations
occurring on the device. This could be further mitigated by exclusively feeding the Pico’s ADC reference with a 3.3V LDO
and removing the R7 resistor on the device. This would disconnect the internal 3.3V rail from the ADC reference entirely.</p>
</section>
<section id="power-regulation-and-filtering">
<h3>Power Regulation and Filtering<a class="headerlink" href="#power-regulation-and-filtering" title="Permalink to this headline"></a></h3>
<p>To supply power to the system, I chose to use the LDL1117 5V and 3.3V low-dropout regulators.
This allows for a 9-12V DC source to supply the devices without much overhead. This provided
a smooth 5V and 3.3V source for most components, with local decoupling capacitors where needed.</p>
<p>In addition to the 5V source, I powered the Raspberry Pico via the VSYS node to activate
the device and use the 3.3V Switching Mode Power Supply (SMPS). This was done using a
Schottky diode from 5V to VSYS to avoid backflow when the Pico is plugged in via USB <a class="footnote-reference brackets" href="#id12" id="id5">13</a>.
The Pico power-chain is good because the SMPS is efficient, but noise on the output causes
problems with other systems like the ADC <a class="footnote-reference brackets" href="#id12" id="id6">13</a>, <a class="footnote-reference brackets" href="#id13" id="id7">14</a>. As a result, I byapassed the SMPS entirely by incorporating a
shutoff switch for the SMPS.</p>
<figure class="align-center" id="id20">
<img alt="../_images/figure18.png" src="../_images/figure18.png" />
<figcaption>
<p><span class="caption-text">Figure 18: Pico Power-chain and the implemented method of external supply <a href="#id29"><span class="problematic" id="id8">[8]_</span></a>.</span><a class="headerlink" href="#id20" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="sd-card-reader">
<h3>SD Card Reader<a class="headerlink" href="#sd-card-reader" title="Permalink to this headline"></a></h3>
<p>An SD card reader has been added via SPI <a class="footnote-reference brackets" href="#id15" id="id9">16</a>. This permits the user to incorporate data collection over time via
sensors and ADC readings. These data readings can be written to text or csv files on a SD card for post test analysis.</p>
</section>
<section id="inputs-and-outputs">
<h3>Inputs and Outputs<a class="headerlink" href="#inputs-and-outputs" title="Permalink to this headline"></a></h3>
<p>A physical reset button was added to the development board to interrupt the RUN pin on the Pico. When this pin is
connected to ground, the device will shut off. To insure proper reset, hold the reset button for 3 seconds. This will
guarantee that the Pico has been discharged. The Pico has a full array of female headers for easy pinout access and
another for seating the pico onboard. Pinout names have been added to the silkscreen simplify development.</p>
</section>
<section id="schematic-and-pcb-design">
<h3>Schematic and PCB Design<a class="headerlink" href="#schematic-and-pcb-design" title="Permalink to this headline"></a></h3>
<figure class="align-center" id="id21">
<img alt="../_images/devboard_schematic1.png" src="../_images/devboard_schematic1.png" />
<figcaption>
<p><span class="caption-text">Figure 22: Devboard schematic page 1 of 2.</span><a class="headerlink" href="#id21" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id22">
<img alt="../_images/devboard_schematic2.png" src="../_images/devboard_schematic2.png" />
<figcaption>
<p><span class="caption-text">Figure 23: Devboard schematic page 2 of 2.</span><a class="headerlink" href="#id22" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id23">
<img alt="../_images/dev_board_top_altium.png" src="../_images/dev_board_top_altium.png" />
<figcaption>
<p><span class="caption-text">Figure 24: Top side of Devboard PCB layout.</span><a class="headerlink" href="#id23" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id24">
<img alt="../_images/dev_board_bottom_altium.png" src="../_images/dev_board_bottom_altium.png" />
<figcaption>
<p><span class="caption-text">Figure 24: Bottom side of Devboard PCB layout.</span><a class="headerlink" href="#id24" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="bill-of-materials">
<h3>Bill Of Materials<a class="headerlink" href="#bill-of-materials" title="Permalink to this headline"></a></h3>
</section>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this headline"></a></h2>
<p>The schematic of the circuit and PCB turned out well, with minimal errors. The
assembled PCB was easy to debug because of its plentiful headers employed in the diagram.
Also, using female headers for the ultrasonic sensors, LCD, DIP packages, and potentiometers
aided debug and ensured that any errors in design could be more easily fixed if the PCB was
routed wrong. Thankfully, there were no design breaking errors in this circuit, and most
components worked immediately after installation.</p>
<figure class="align-center" id="id25">
<img alt="../_images/dev_board_assembled.jpg" src="../_images/dev_board_assembled.jpg" />
<figcaption>
<p><span class="caption-text">Figure 42: Raspberry Pico Development Board</span><a class="headerlink" href="#id25" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<section id="power">
<h3>Power<a class="headerlink" href="#power" title="Permalink to this headline"></a></h3>
<p>The power regulation and filtering produced a 5V and 3.3V source with minimal noise, observed
with as little as 10mV ripple on both sources.</p>
<figure class="align-center" id="id26">
<img alt="../_images/powerchain.jpg" src="../_images/powerchain.jpg" />
<figcaption>
<p><span class="caption-text">Figure 27: Power regulation system on the PCB</span><a class="headerlink" href="#id26" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id27">
<img alt="../_images/scope_power.png" src="../_images/scope_power.png" />
<figcaption>
<p><span class="caption-text">Figure 28: 5V and 3.3V source observed on the oscilloscope.</span><a class="headerlink" href="#id27" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id28">
<img alt="../_images/scope_power_zoom.png" src="../_images/scope_power_zoom.png" />
<figcaption>
<p><span class="caption-text">Figure 29: 5V and 3.3V source observed on the oscilloscope, both from a 20mV div.</span><a class="headerlink" href="#id28" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
</section>
<section id="appendix">
<h2>Appendix<a class="headerlink" href="#appendix" title="Permalink to this headline"></a></h2>
<section id="lcd-py">
<h3>LCD.py<a class="headerlink" href="#lcd-py" title="Permalink to this headline"></a></h3>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">#--------------------------------------------------</span>
<span class="linenos">  2</span><span class="c1">#       PARALLEL LCD FUNCTIONS</span>
<span class="linenos">  3</span><span class="c1">#       ======================</span>
<span class="linenos">  4</span><span class="c1">#</span>
<span class="linenos">  5</span><span class="c1"># These functions initialize and control the LCD</span>
<span class="linenos">  6</span><span class="c1">#</span>
<span class="linenos">  7</span><span class="c1"># Author: Dogan Ibrahim</span>
<span class="linenos">  8</span><span class="c1"># File  : LCD</span>
<span class="linenos">  9</span><span class="c1"># Date  : August, 2021</span>
<span class="linenos"> 10</span><span class="c1">#--------------------------------------------------</span>
<span class="linenos"> 11</span><span class="c1"># Modified by Dieter Steinhauser</span>
<span class="linenos"> 12</span><span class="c1">#--------------------------------------------------</span>
<span class="linenos"> 13</span><span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">Pin</span>
<span class="linenos"> 14</span><span class="kn">import</span> <span class="nn">utime</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="c1"># ----------------------</span>
<span class="linenos"> 17</span><span class="n">LCD_CMD</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 18</span><span class="n">LCD_DATA</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos"> 19</span><span class="c1"># ----------------------</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="c1"># GPIO Wiring</span>
<span class="linenos"> 22</span><span class="c1"># ----------------------</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="n">EN</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 26</span><span class="n">RS</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 27</span><span class="n">D4</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 28</span><span class="n">D5</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 29</span><span class="n">D6</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 30</span><span class="n">D7</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 31</span><span class="n">PORT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="linenos"> 32</span><span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span><span class="c1"># Methods</span>
<span class="linenos"> 36</span><span class="c1"># ----------------------</span>
<span class="linenos"> 37</span>
<span class="linenos"> 38</span><span class="k">def</span> <span class="nf">Configure</span><span class="p">():</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
<span class="linenos"> 41</span>       <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="n">PORT</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos"> 42</span>    
<span class="linenos"> 43</span><span class="k">def</span> <span class="nf">lcd_strobe</span><span class="p">():</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span>    <span class="n">EN</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 46</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 47</span>    <span class="n">EN</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 48</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 49</span>    
<span class="linenos"> 50</span><span class="k">def</span> <span class="nf">lcd_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 53</span>       <span class="n">d</span> <span class="o">=</span> <span class="n">c</span>
<span class="linenos"> 54</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 55</span>       <span class="n">d</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="linenos"> 56</span>    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
<span class="linenos"> 57</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
<span class="linenos"> 58</span>        <span class="n">b</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="mi">1</span>
<span class="linenos"> 59</span>        <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="linenos"> 60</span>        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
<span class="linenos"> 61</span>    <span class="n">RS</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
<span class="linenos"> 62</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos"> 63</span>    
<span class="linenos"> 64</span>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 65</span>       <span class="n">d</span> <span class="o">=</span> <span class="n">c</span>
<span class="linenos"> 66</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 67</span>       <span class="n">d</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="linenos"> 68</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
<span class="linenos"> 69</span>        <span class="n">b</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="mi">1</span>
<span class="linenos"> 70</span>        <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="linenos"> 71</span>        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
<span class="linenos"> 72</span>    <span class="n">RS</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
<span class="linenos"> 73</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos"> 74</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 75</span>    <span class="n">RS</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span><span class="k">def</span> <span class="nf">lcd_clear</span><span class="p">():</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 80</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="k">def</span> <span class="nf">lcd_home</span><span class="p">():</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 85</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="k">def</span> <span class="nf">lcd_cursor_blink</span><span class="p">():</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x0D</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 90</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="k">def</span> <span class="nf">lcd_cursor_on</span><span class="p">():</span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x0E</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 95</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span><span class="k">def</span> <span class="nf">lcd_cursor_off</span><span class="p">():</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">100</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">101</span>
<span class="linenos">102</span><span class="k">def</span> <span class="nf">lcd_puts</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="linenos">103</span>
<span class="linenos">104</span>    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="linenos">105</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
<span class="linenos">106</span>       <span class="n">lcd_putch</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="linenos">107</span>
<span class="linenos">108</span><span class="k">def</span> <span class="nf">lcd_putch</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
<span class="linenos">109</span>
<span class="linenos">110</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">111</span>
<span class="linenos">112</span><span class="k">def</span> <span class="nf">lcd_goto</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
<span class="linenos">113</span>    <span class="n">c</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">114</span>    <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">115</span>        <span class="n">address</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">116</span>    <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">117</span>        <span class="n">address</span> <span class="o">=</span> <span class="mh">0x40</span>
<span class="linenos">118</span>    <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">119</span>        <span class="n">address</span> <span class="o">=</span> <span class="mh">0x14</span>
<span class="linenos">120</span>    <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos">121</span>        <span class="n">address</span> <span class="o">=</span> <span class="mh">0x54</span>
<span class="linenos">122</span>    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span> <span class="o">+</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span>
<span class="linenos">123</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">124</span>
<span class="linenos">125</span><span class="k">def</span> <span class="nf">lcd_init</span><span class="p">():</span>
<span class="linenos">126</span>    
<span class="linenos">127</span>    <span class="n">Configure</span><span class="p">()</span>
<span class="linenos">128</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
<span class="linenos">129</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
<span class="linenos">130</span>        <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">131</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="linenos">132</span>    <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">133</span>    <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">134</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos">135</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">136</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos">137</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">138</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos">139</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">140</span>    <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">141</span>    <span class="n">lcd_strobe</span><span class="p">()</span>
<span class="linenos">142</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos">143</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">144</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">145</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">146</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">147</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">148</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">149</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x06</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">150</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos">151</span>    <span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">152</span>    <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">153</span><span class="c1">#================= END OF LCD FUNCTIONS =======================</span>
<span class="linenos">154</span>
<span class="linenos">155</span>
<span class="linenos">156</span>
<span class="linenos">157</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="sdcard-py">
<h3>sdcard.py<a class="headerlink" href="#sdcard-py" title="Permalink to this headline"></a></h3>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">MicroPython driver for SD cards using SPI bus.</span>
<span class="linenos">  3</span>
<span class="linenos">  4</span><span class="sd">Requires an SPI bus and a CS pin.  Provides readblocks and writeblocks</span>
<span class="linenos">  5</span><span class="sd">methods so the device can be mounted as a filesystem.</span>
<span class="linenos">  6</span>
<span class="linenos">  7</span><span class="sd">Example usage on pyboard:</span>
<span class="linenos">  8</span>
<span class="linenos">  9</span><span class="sd">    import pyb, sdcard, os</span>
<span class="linenos"> 10</span><span class="sd">    sd = sdcard.SDCard(pyb.SPI(1), pyb.Pin.board.X5)</span>
<span class="linenos"> 11</span><span class="sd">    pyb.mount(sd, &#39;/sd2&#39;)</span>
<span class="linenos"> 12</span><span class="sd">    os.listdir(&#39;/&#39;)</span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="sd">Example usage on ESP8266:</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="sd">    import machine, sdcard, os</span>
<span class="linenos"> 17</span><span class="sd">    sd = sdcard.SDCard(machine.SPI(1), machine.Pin(15))</span>
<span class="linenos"> 18</span><span class="sd">    os.mount(sd, &#39;/sd&#39;)</span>
<span class="linenos"> 19</span><span class="sd">    os.listdir(&#39;/&#39;)</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 22</span>
<span class="linenos"> 23</span><span class="kn">from</span> <span class="nn">micropython</span> <span class="kn">import</span> <span class="n">const</span>
<span class="linenos"> 24</span><span class="kn">import</span> <span class="nn">time</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span>
<span class="linenos"> 27</span><span class="n">_CMD_TIMEOUT</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="n">_R1_IDLE_STATE</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 30</span><span class="c1"># R1_ERASE_RESET = const(1 &lt;&lt; 1)</span>
<span class="linenos"> 31</span><span class="n">_R1_ILLEGAL_COMMAND</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 32</span><span class="c1"># R1_COM_CRC_ERROR = const(1 &lt;&lt; 3)</span>
<span class="linenos"> 33</span><span class="c1"># R1_ERASE_SEQUENCE_ERROR = const(1 &lt;&lt; 4)</span>
<span class="linenos"> 34</span><span class="c1"># R1_ADDRESS_ERROR = const(1 &lt;&lt; 5)</span>
<span class="linenos"> 35</span><span class="c1"># R1_PARAMETER_ERROR = const(1 &lt;&lt; 6)</span>
<span class="linenos"> 36</span><span class="n">_TOKEN_CMD25</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0xFC</span><span class="p">)</span>
<span class="linenos"> 37</span><span class="n">_TOKEN_STOP_TRAN</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0xFD</span><span class="p">)</span>
<span class="linenos"> 38</span><span class="n">_TOKEN_DATA</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0xFE</span><span class="p">)</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span>
<span class="linenos"> 41</span><span class="k">class</span> <span class="nc">SDCard</span><span class="p">:</span>
<span class="linenos"> 42</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spi</span><span class="p">,</span> <span class="n">cs</span><span class="p">):</span>
<span class="linenos"> 43</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span> <span class="o">=</span> <span class="n">spi</span>
<span class="linenos"> 44</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="linenos"> 47</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dummybuf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
<span class="linenos"> 48</span>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenbuf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 49</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">512</span><span class="p">):</span>
<span class="linenos"> 50</span>            <span class="bp">self</span><span class="o">.</span><span class="n">dummybuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span>
<span class="linenos"> 51</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dummybuf_memoryview</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dummybuf</span><span class="p">)</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span>        <span class="c1"># initialise the card</span>
<span class="linenos"> 54</span>        <span class="bp">self</span><span class="o">.</span><span class="n">init_card</span><span class="p">()</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span>    <span class="k">def</span> <span class="nf">init_spi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">):</span>
<span class="linenos"> 57</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 58</span>            <span class="n">master</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">MASTER</span>
<span class="linenos"> 59</span>        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
<span class="linenos"> 60</span>            <span class="c1"># on ESP8266</span>
<span class="linenos"> 61</span>            <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">baudrate</span><span class="o">=</span><span class="n">baudrate</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">polarity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 62</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 63</span>            <span class="c1"># on pyboard</span>
<span class="linenos"> 64</span>            <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="n">baudrate</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">polarity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span>    <span class="k">def</span> <span class="nf">init_card</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 67</span>        <span class="c1"># init CS pin</span>
<span class="linenos"> 68</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span>        <span class="c1"># init SPI bus; use low data rate for initialisation</span>
<span class="linenos"> 71</span>        <span class="bp">self</span><span class="o">.</span><span class="n">init_spi</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span>        <span class="c1"># clock card at least 100 cycles with cs high</span>
<span class="linenos"> 74</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
<span class="linenos"> 75</span>            <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span>        <span class="c1"># CMD0: init card; should return _R1_IDLE_STATE (allow 5 attempts)</span>
<span class="linenos"> 78</span>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<span class="linenos"> 79</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">)</span> <span class="o">==</span> <span class="n">_R1_IDLE_STATE</span><span class="p">:</span>
<span class="linenos"> 80</span>                <span class="k">break</span>
<span class="linenos"> 81</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 82</span>            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;no SD card&quot;</span><span class="p">)</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span>        <span class="c1"># CMD8: determine card version</span>
<span class="linenos"> 85</span>        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x01AA</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="linenos"> 86</span>        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">_R1_IDLE_STATE</span><span class="p">:</span>
<span class="linenos"> 87</span>            <span class="bp">self</span><span class="o">.</span><span class="n">init_card_v2</span><span class="p">()</span>
<span class="linenos"> 88</span>        <span class="k">elif</span> <span class="n">r</span> <span class="o">==</span> <span class="p">(</span><span class="n">_R1_IDLE_STATE</span> <span class="o">|</span> <span class="n">_R1_ILLEGAL_COMMAND</span><span class="p">):</span>
<span class="linenos"> 89</span>            <span class="bp">self</span><span class="o">.</span><span class="n">init_card_v1</span><span class="p">()</span>
<span class="linenos"> 90</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 91</span>            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t determine SD card version&quot;</span><span class="p">)</span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span>        <span class="c1"># get the number of sectors</span>
<span class="linenos"> 94</span>        <span class="c1"># CMD9: response R2 (R1 byte + 16-byte block read)</span>
<span class="linenos"> 95</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 96</span>            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;no response from SD card&quot;</span><span class="p">)</span>
<span class="linenos"> 97</span>        <span class="n">csd</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="linenos"> 98</span>        <span class="bp">self</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">csd</span><span class="p">)</span>
<span class="linenos"> 99</span>        <span class="k">if</span> <span class="n">csd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">:</span>  <span class="c1"># CSD version 2.0</span>
<span class="linenos">100</span>            <span class="bp">self</span><span class="o">.</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">((</span><span class="n">csd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">csd</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="linenos">101</span>        <span class="k">elif</span> <span class="n">csd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>  <span class="c1"># CSD version 1.0 (old, &lt;=2GB)</span>
<span class="linenos">102</span>            <span class="n">c_size</span> <span class="o">=</span> <span class="n">csd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mb">0b11</span> <span class="o">|</span> <span class="n">csd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="p">(</span><span class="n">csd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mb">0b11000000</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
<span class="linenos">103</span>            <span class="n">c_size_mult</span> <span class="o">=</span> <span class="p">((</span><span class="n">csd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mb">0b11</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">csd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span>
<span class="linenos">104</span>            <span class="bp">self</span><span class="o">.</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">c_size_mult</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
<span class="linenos">105</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">106</span>            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;SD card CSD format not supported&quot;</span><span class="p">)</span>
<span class="linenos">107</span>        <span class="c1"># print(&#39;sectors&#39;, self.sectors)</span>
<span class="linenos">108</span>
<span class="linenos">109</span>        <span class="c1"># CMD16: set block length to 512 bytes</span>
<span class="linenos">110</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">111</span>            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;can&#39;t set 512 block size&quot;</span><span class="p">)</span>
<span class="linenos">112</span>
<span class="linenos">113</span>        <span class="c1"># set to high data rate now that it&#39;s initialised</span>
<span class="linenos">114</span>        <span class="bp">self</span><span class="o">.</span><span class="n">init_spi</span><span class="p">(</span><span class="mi">1320000</span><span class="p">)</span>
<span class="linenos">115</span>
<span class="linenos">116</span>    <span class="k">def</span> <span class="nf">init_card_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">117</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_CMD_TIMEOUT</span><span class="p">):</span>
<span class="linenos">118</span>            <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">119</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">41</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">120</span>                <span class="bp">self</span><span class="o">.</span><span class="n">cdv</span> <span class="o">=</span> <span class="mi">512</span>
<span class="linenos">121</span>                <span class="c1"># print(&quot;[SDCard] v1 card&quot;)</span>
<span class="linenos">122</span>                <span class="k">return</span>
<span class="linenos">123</span>        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;timeout waiting for v1 card&quot;</span><span class="p">)</span>
<span class="linenos">124</span>
<span class="linenos">125</span>    <span class="k">def</span> <span class="nf">init_card_v2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">126</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_CMD_TIMEOUT</span><span class="p">):</span>
<span class="linenos">127</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="linenos">128</span>            <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">58</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="linenos">129</span>            <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">130</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">41</span><span class="p">,</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">131</span>                <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">58</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="linenos">132</span>                <span class="bp">self</span><span class="o">.</span><span class="n">cdv</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">133</span>                <span class="c1"># print(&quot;[SDCard] v2 card&quot;)</span>
<span class="linenos">134</span>                <span class="k">return</span>
<span class="linenos">135</span>        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;timeout waiting for v2 card&quot;</span><span class="p">)</span>
<span class="linenos">136</span>
<span class="linenos">137</span>    <span class="k">def</span> <span class="nf">cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip1</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">138</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">139</span>
<span class="linenos">140</span>        <span class="c1"># create and send the command</span>
<span class="linenos">141</span>        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdbuf</span>
<span class="linenos">142</span>        <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">cmd</span>
<span class="linenos">143</span>        <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span>
<span class="linenos">144</span>        <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
<span class="linenos">145</span>        <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span>
<span class="linenos">146</span>        <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span>
<span class="linenos">147</span>        <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span>
<span class="linenos">148</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="linenos">149</span>
<span class="linenos">150</span>        <span class="k">if</span> <span class="n">skip1</span><span class="p">:</span>
<span class="linenos">151</span>            <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenbuf</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">)</span>
<span class="linenos">152</span>
<span class="linenos">153</span>        <span class="c1"># wait for the response (response[7] == 0)</span>
<span class="linenos">154</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_CMD_TIMEOUT</span><span class="p">):</span>
<span class="linenos">155</span>            <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenbuf</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">)</span>
<span class="linenos">156</span>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">157</span>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">response</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">):</span>
<span class="linenos">158</span>                <span class="c1"># this could be a big-endian integer that we are getting here</span>
<span class="linenos">159</span>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">final</span><span class="p">):</span>
<span class="linenos">160</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">161</span>                <span class="k">if</span> <span class="n">release</span><span class="p">:</span>
<span class="linenos">162</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">163</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">164</span>                <span class="k">return</span> <span class="n">response</span>
<span class="linenos">165</span>
<span class="linenos">166</span>        <span class="c1"># timeout</span>
<span class="linenos">167</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">168</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">169</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
<span class="linenos">170</span>
<span class="linenos">171</span>    <span class="k">def</span> <span class="nf">readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
<span class="linenos">172</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">173</span>
<span class="linenos">174</span>        <span class="c1"># read until start byte (0xff)</span>
<span class="linenos">175</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_CMD_TIMEOUT</span><span class="p">):</span>
<span class="linenos">176</span>            <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenbuf</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">)</span>
<span class="linenos">177</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">_TOKEN_DATA</span><span class="p">:</span>
<span class="linenos">178</span>                <span class="k">break</span>
<span class="linenos">179</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">180</span>            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">181</span>            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;timeout waiting for response&quot;</span><span class="p">)</span>
<span class="linenos">182</span>
<span class="linenos">183</span>        <span class="c1"># read data</span>
<span class="linenos">184</span>        <span class="n">mv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummybuf_memoryview</span>
<span class="linenos">185</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mv</span><span class="p">):</span>
<span class="linenos">186</span>            <span class="n">mv</span> <span class="o">=</span> <span class="n">mv</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)]</span>
<span class="linenos">187</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write_readinto</span><span class="p">(</span><span class="n">mv</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="linenos">188</span>
<span class="linenos">189</span>        <span class="c1"># read checksum</span>
<span class="linenos">190</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">191</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">192</span>
<span class="linenos">193</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">194</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">195</span>
<span class="linenos">196</span>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
<span class="linenos">197</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">198</span>
<span class="linenos">199</span>        <span class="c1"># send: start of block, data, checksum</span>
<span class="linenos">200</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
<span class="linenos">201</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="linenos">202</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">203</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">204</span>
<span class="linenos">205</span>        <span class="c1"># check the response</span>
<span class="linenos">206</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x05</span><span class="p">:</span>
<span class="linenos">207</span>            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">208</span>            <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">209</span>            <span class="k">return</span>
<span class="linenos">210</span>
<span class="linenos">211</span>        <span class="c1"># wait for write to finish</span>
<span class="linenos">212</span>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">213</span>            <span class="k">pass</span>
<span class="linenos">214</span>
<span class="linenos">215</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">216</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">217</span>
<span class="linenos">218</span>    <span class="k">def</span> <span class="nf">write_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="linenos">219</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">220</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
<span class="linenos">221</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">222</span>        <span class="c1"># wait for write to finish</span>
<span class="linenos">223</span>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>
<span class="linenos">224</span>            <span class="k">pass</span>
<span class="linenos">225</span>
<span class="linenos">226</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">227</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">228</span>
<span class="linenos">229</span>    <span class="k">def</span> <span class="nf">readblocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_num</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
<span class="linenos">230</span>        <span class="n">nblocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">//</span> <span class="mi">512</span>
<span class="linenos">231</span>        <span class="k">assert</span> <span class="n">nblocks</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">%</span> <span class="mi">512</span><span class="p">,</span> <span class="s2">&quot;Buffer length is invalid&quot;</span>
<span class="linenos">232</span>        <span class="k">if</span> <span class="n">nblocks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">233</span>            <span class="c1"># CMD17: set read address for single block</span>
<span class="linenos">234</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="n">block_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">235</span>                <span class="c1"># release the card</span>
<span class="linenos">236</span>                <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">237</span>                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># EIO</span>
<span class="linenos">238</span>            <span class="c1"># receive the data and release card</span>
<span class="linenos">239</span>            <span class="bp">self</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="linenos">240</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">241</span>            <span class="c1"># CMD18: set read address for multiple blocks</span>
<span class="linenos">242</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="n">block_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">243</span>                <span class="c1"># release the card</span>
<span class="linenos">244</span>                <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">245</span>                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># EIO</span>
<span class="linenos">246</span>            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">247</span>            <span class="n">mv</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="linenos">248</span>            <span class="k">while</span> <span class="n">nblocks</span><span class="p">:</span>
<span class="linenos">249</span>                <span class="c1"># receive the data and release card</span>
<span class="linenos">250</span>                <span class="bp">self</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">mv</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">512</span><span class="p">])</span>
<span class="linenos">251</span>                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">512</span>
<span class="linenos">252</span>                <span class="n">nblocks</span> <span class="o">-=</span> <span class="mi">1</span>
<span class="linenos">253</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">skip1</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos">254</span>                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># EIO</span>
<span class="linenos">255</span>
<span class="linenos">256</span>    <span class="k">def</span> <span class="nf">writeblocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_num</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
<span class="linenos">257</span>        <span class="n">nblocks</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">512</span><span class="p">)</span>
<span class="linenos">258</span>        <span class="k">assert</span> <span class="n">nblocks</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">err</span><span class="p">,</span> <span class="s2">&quot;Buffer length is invalid&quot;</span>
<span class="linenos">259</span>        <span class="k">if</span> <span class="n">nblocks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">260</span>            <span class="c1"># CMD24: set write address for single block</span>
<span class="linenos">261</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">block_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdv</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">262</span>                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># EIO</span>
<span class="linenos">263</span>
<span class="linenos">264</span>            <span class="c1"># send the data</span>
<span class="linenos">265</span>            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_TOKEN_DATA</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="linenos">266</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">267</span>            <span class="c1"># CMD25: set write address for first block</span>
<span class="linenos">268</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="n">block_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdv</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">269</span>                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># EIO</span>
<span class="linenos">270</span>            <span class="c1"># send the data</span>
<span class="linenos">271</span>            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">272</span>            <span class="n">mv</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="linenos">273</span>            <span class="k">while</span> <span class="n">nblocks</span><span class="p">:</span>
<span class="linenos">274</span>                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_TOKEN_CMD25</span><span class="p">,</span> <span class="n">mv</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">512</span><span class="p">])</span>
<span class="linenos">275</span>                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">512</span>
<span class="linenos">276</span>                <span class="n">nblocks</span> <span class="o">-=</span> <span class="mi">1</span>
<span class="linenos">277</span>            <span class="bp">self</span><span class="o">.</span><span class="n">write_token</span><span class="p">(</span><span class="n">_TOKEN_STOP_TRAN</span><span class="p">)</span>
<span class="linenos">278</span>
<span class="linenos">279</span>    <span class="k">def</span> <span class="nf">ioctl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="linenos">280</span>        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># get number of blocks</span>
<span class="linenos">281</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sectors</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="test-py">
<h3>test.py<a class="headerlink" href="#test-py" title="Permalink to this headline"></a></h3>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">  2</span><span class="c1">#                 NOTES </span>
<span class="linenos">  3</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">  4</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  5</span><span class="sd">Dieter Steinhauser</span>
<span class="linenos">  6</span><span class="sd">12/2022</span>
<span class="linenos">  7</span><span class="sd">PicoPAD Test Script</span>
<span class="linenos">  8</span>
<span class="linenos">  9</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 12</span><span class="c1">#               IMPORTS</span>
<span class="linenos"> 13</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span><span class="kn">from</span> <span class="nn">LCD</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 16</span><span class="c1"># import _thread</span>
<span class="linenos"> 17</span><span class="kn">from</span> <span class="nn">utime</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">sleep_ms</span><span class="p">,</span> <span class="n">sleep_us</span><span class="p">,</span> <span class="n">ticks_ms</span>
<span class="linenos"> 18</span><span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">Timer</span><span class="p">,</span> <span class="n">ADC</span><span class="p">,</span> <span class="n">freq</span>
<span class="linenos"> 19</span><span class="c1"># import gc</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 22</span><span class="c1">#         CONSTANTS/VARIABLES</span>
<span class="linenos"> 23</span><span class="c1"># -----------------------------------------   </span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="c1"># ------------------</span>
<span class="linenos"> 26</span><span class="n">REFRESH_RATE</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Frequency in Hz</span>
<span class="linenos"> 27</span><span class="n">REFRESH_PERIOD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">REFRESH_RATE</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># delay in milliseconds</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="c1"># ------------------</span>
<span class="linenos"> 30</span><span class="n">UPY_BIT_RES</span> <span class="o">=</span> <span class="mi">16</span>
<span class="linenos"> 31</span><span class="n">ADC_REF</span> <span class="o">=</span> <span class="mf">3.3</span>
<span class="linenos"> 32</span><span class="n">VOLT_PER_BIT</span> <span class="o">=</span> <span class="n">ADC_REF</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">UPY_BIT_RES</span><span class="p">)</span> <span class="c1"># ADC recieves in 2 byte packets and micropython automagically fixes it.</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span><span class="c1"># ------------------</span>
<span class="linenos"> 35</span><span class="n">DAC_REF</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="linenos"> 36</span><span class="n">DC_OFFSET</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 37</span><span class="n">DC_OFFSET_RES</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">DC_OFFSET</span> <span class="o">/</span> <span class="n">DAC_REF</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">UPY_BIT_RES</span><span class="p">))</span>
<span class="linenos"> 38</span>
<span class="linenos"> 39</span><span class="c1"># ------------------</span>
<span class="linenos"> 40</span><span class="n">FREQ_MAX</span> <span class="o">=</span> <span class="mi">160</span>
<span class="linenos"> 41</span><span class="n">FREQ_MIN</span> <span class="o">=</span> <span class="mi">10</span>
<span class="linenos"> 42</span><span class="n">AMP_MAX</span> <span class="o">=</span> <span class="n">DAC_REF</span>
<span class="linenos"> 43</span><span class="n">AMP_MIN</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="n">MAX_DIST_US0</span> <span class="o">=</span> <span class="mi">50</span>
<span class="linenos"> 46</span><span class="n">MAX_DIST_US1</span> <span class="o">=</span> <span class="mi">20</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span><span class="c1"># -------------------------------------------------------------</span>
<span class="linenos"> 50</span><span class="c1">#           INITIALIZATION</span>
<span class="linenos"> 51</span><span class="c1"># -------------------------------------------------------------</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 54</span><span class="c1">#           SYSTEM CLOCK</span>
<span class="linenos"> 55</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="n">DEFAULT_SYS_CLK</span> <span class="o">=</span> <span class="mi">125_000_000</span>
<span class="linenos"> 58</span><span class="n">STABLE_OVERCLOCK</span> <span class="o">=</span> <span class="mi">270_000_000</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="c1"># Pico can go up to 270MHz before needing to flash to the eeprom directly.</span>
<span class="linenos"> 61</span><span class="n">system_clock</span> <span class="o">=</span> <span class="n">DEFAULT_SYS_CLK</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="c1"># if the system clock is not the default, apply the clock speed.</span>
<span class="linenos"> 64</span><span class="k">if</span> <span class="n">system_clock</span> <span class="o">!=</span>  <span class="n">DEFAULT_SYS_CLK</span><span class="p">:</span>
<span class="linenos"> 65</span>    <span class="n">freq</span><span class="p">(</span><span class="n">system_clock</span><span class="p">)</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span><span class="c1"># print(f&#39;Clock: {freq()/1e6}MHz&#39;)</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 70</span><span class="c1">#               PINOUT</span>
<span class="linenos"> 71</span><span class="c1"># -----------------------------------------</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span><span class="c1"># LCD Pins handled in LCD.py</span>
<span class="linenos"> 74</span><span class="c1"># ----------------------------</span>
<span class="linenos"> 75</span><span class="c1"># EN = Pin(0, Pin.OUT)</span>
<span class="linenos"> 76</span><span class="c1"># RS = Pin(1, Pin.OUT)</span>
<span class="linenos"> 77</span><span class="c1"># D7 = Pin(2, Pin.OUT)</span>
<span class="linenos"> 78</span><span class="c1"># D6 = Pin(3, Pin.OUT)</span>
<span class="linenos"> 79</span><span class="c1"># D5 = Pin(4, Pin.OUT)</span>
<span class="linenos"> 80</span><span class="c1"># D4 = Pin(5, Pin.OUT)</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="c1"># Ultrasonic sensor pins handled in sensors.py</span>
<span class="linenos"> 83</span><span class="c1"># ----------------------------</span>
<span class="linenos"> 84</span><span class="c1"># us0_trig = Pin(6, Pin.OUT)</span>
<span class="linenos"> 85</span><span class="c1"># us0_echo = Pin(7, Pin.IN)</span>
<span class="linenos"> 86</span><span class="c1"># us1_trig = Pin(8, Pin.OUT)</span>
<span class="linenos"> 87</span><span class="c1"># us1_echo = Pin(9, Pin.IN)</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="c1"># Switches</span>
<span class="linenos"> 90</span><span class="c1"># ----------------------------</span>
<span class="linenos"> 91</span><span class="c1"># sw0 = Pin(10, Pin.IN, Pin.PULL_DOWN)</span>
<span class="linenos"> 92</span><span class="c1"># sw1 = Pin(11, Pin.IN, Pin.PULL_DOWN)</span>
<span class="linenos"> 93</span><span class="c1"># sw2 = Pin(12, Pin.IN, Pin.PULL_DOWN)</span>
<span class="linenos"> 94</span><span class="c1"># sw3 = Pin(13, Pin.IN, Pin.PULL_DOWN)</span>
<span class="linenos"> 95</span><span class="c1"># switch_pins = [sw0, sw1, sw2, sw3]</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span><span class="c1"># LEDs</span>
<span class="linenos"> 98</span><span class="c1"># ----------------------------</span>
<span class="linenos"> 99</span><span class="c1"># led0 = Pin(14, Pin.OUT)</span>
<span class="linenos">100</span><span class="c1"># led1 = Pin(15, Pin.OUT)</span>
<span class="linenos">101</span><span class="n">led_onboard</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">102</span><span class="c1"># led_pins = [led0, led1, led_onboard]</span>
<span class="linenos">103</span>
<span class="linenos">104</span><span class="c1"># SPI handled by the Hardware in spi_config.py</span>
<span class="linenos">105</span><span class="c1"># ----------------------------</span>
<span class="linenos">106</span><span class="c1"># miso = Pin(16, Pin.IN)</span>
<span class="linenos">107</span><span class="c1"># cs = Pin(17, Pin.OUT, value=1)</span>
<span class="linenos">108</span><span class="c1"># mosi = Pin(18, Pin.OUT)</span>
<span class="linenos">109</span><span class="c1"># sck = Pin(19, Pin.OUT)</span>
<span class="linenos">110</span>
<span class="linenos">111</span><span class="c1"># Buttons</span>
<span class="linenos">112</span><span class="c1"># ----------------------------</span>
<span class="linenos">113</span><span class="c1"># button0 = Pin(20, Pin.IN)</span>
<span class="linenos">114</span><span class="c1"># button1 = Pin(21, Pin.IN)</span>
<span class="linenos">115</span><span class="c1"># button2 = Pin(22, Pin.IN)</span>
<span class="linenos">116</span><span class="c1"># button3 = Pin(28, Pin.IN)</span>
<span class="linenos">117</span><span class="c1"># button_pins = [button0, button1, button2, button3]</span>
<span class="linenos">118</span>
<span class="linenos">119</span><span class="c1"># ADC</span>
<span class="linenos">120</span><span class="c1"># ----------------------------</span>
<span class="linenos">121</span><span class="c1"># adc0 = ADC(26) # Connect to GP26, which is channel 0</span>
<span class="linenos">122</span><span class="c1"># adc1 = ADC(27) # Connect to GP27, which is channel 1</span>
<span class="linenos">123</span>
<span class="linenos">124</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">125</span><span class="c1">#           LCD</span>
<span class="linenos">126</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">127</span><span class="n">lcd_init</span><span class="p">()</span>
<span class="linenos">128</span><span class="n">lcd_clear</span><span class="p">()</span>
<span class="linenos">129</span><span class="c1"># lcd_cursor_on()</span>
<span class="linenos">130</span><span class="c1"># lcd_cursor_blink()</span>
<span class="linenos">131</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">132</span><span class="c1">#           ADC</span>
<span class="linenos">133</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">134</span><span class="n">adc0</span> <span class="o">=</span> <span class="n">ADC</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span> <span class="c1"># Connect to GP26, which is channel 0</span>
<span class="linenos">135</span><span class="n">adc1</span> <span class="o">=</span> <span class="n">ADC</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="c1"># Connect to GP27, which is channel 1</span>
<span class="linenos">136</span><span class="c1"># adc2 = machine.ADC(28) # Connect to GP28, which is channel 2</span>
<span class="linenos">137</span><span class="c1"># adc_reading = adc0.read_u16() * VOLT_PER_BIT # read and report the ADC reading</span>
<span class="linenos">138</span>
<span class="linenos">139</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">140</span><span class="c1">#           SD CARD VIA SPI</span>
<span class="linenos">141</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">142</span><span class="c1"># </span>
<span class="linenos">143</span><span class="c1"># import sdcard</span>
<span class="linenos">144</span><span class="c1"># import os</span>
<span class="linenos">145</span><span class="c1"># import uos</span>
<span class="linenos">146</span><span class="c1"># </span>
<span class="linenos">147</span><span class="c1"># # Assign chip select (CS) pin (and start it high)</span>
<span class="linenos">148</span><span class="c1"># cs = Pin(20, machine.Pin.OUT)</span>
<span class="linenos">149</span><span class="c1"># </span>
<span class="linenos">150</span><span class="c1"># # Intialize SPI peripheral (start with 1 MHz)</span>
<span class="linenos">151</span><span class="c1"># spi = machine.SPI(0,</span>
<span class="linenos">152</span><span class="c1">#                   baudrate=1000000,</span>
<span class="linenos">153</span><span class="c1">#                   polarity=0,</span>
<span class="linenos">154</span><span class="c1">#                   phase=0,</span>
<span class="linenos">155</span><span class="c1">#                   bits=8,</span>
<span class="linenos">156</span><span class="c1">#                   firstbit=machine.SPI.MSB,</span>
<span class="linenos">157</span><span class="c1">#                   sck=Pin(18),</span>
<span class="linenos">158</span><span class="c1">#                   mosi=Pin(19),</span>
<span class="linenos">159</span><span class="c1">#                   miso=Pin(16))</span>
<span class="linenos">160</span><span class="c1"># </span>
<span class="linenos">161</span><span class="c1"># # Initialize SD card</span>
<span class="linenos">162</span><span class="c1"># sd = sdcard.SDCard(spi, cs)</span>
<span class="linenos">163</span><span class="c1"># </span>
<span class="linenos">164</span><span class="c1"># vfs = uos.VfsFat(sd)</span>
<span class="linenos">165</span><span class="c1"># uos.mount(vfs, &quot;/sd&quot;)</span>
<span class="linenos">166</span><span class="c1"># </span>
<span class="linenos">167</span><span class="c1"># # Create a file and write something to it</span>
<span class="linenos">168</span><span class="c1"># file = open(&quot;/sd/test01.txt&quot;, &quot;w&quot;)</span>
<span class="linenos">169</span><span class="c1"># </span>
<span class="linenos">170</span><span class="c1"># with open(&quot;/sd/test01.txt&quot;, &quot;w&quot;) as file:</span>
<span class="linenos">171</span><span class="c1">#     file.write(&quot;Hello, SD World!\r\n&quot;)</span>
<span class="linenos">172</span><span class="c1">#     file.write(&quot;This is a test\r\n&quot;)</span>
<span class="linenos">173</span><span class="c1"># </span>
<span class="linenos">174</span><span class="c1"># # Open the file we just created and read from it</span>
<span class="linenos">175</span><span class="c1"># with open(&quot;/sd/test01.txt&quot;, &quot;r&quot;) as file:</span>
<span class="linenos">176</span><span class="c1">#     data = file.read()</span>
<span class="linenos">177</span><span class="c1">#     print(data)</span>
<span class="linenos">178</span>
<span class="linenos">179</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">180</span><span class="c1">#           PROCESS 1: IO</span>
<span class="linenos">181</span><span class="c1"># -----------------------------------------</span>
<span class="linenos">182</span>
<span class="linenos">183</span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">184</span>
<span class="linenos">185</span>    <span class="n">splash</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">186</span>    <span class="c1"># Display the splash screen on startup.</span>
<span class="linenos">187</span>    <span class="k">if</span> <span class="n">splash</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">188</span>        <span class="n">led_onboard</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">189</span>        <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PicoPAD Test  &#39;</span><span class="p">)</span>
<span class="linenos">190</span>        <span class="n">lcd_goto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">191</span>        <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dieter S.        &#39;</span><span class="p">)</span>
<span class="linenos">192</span>        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">193</span>        <span class="n">lcd_home</span><span class="p">()</span>
<span class="linenos">194</span>        <span class="n">lcd_clear</span><span class="p">()</span>
<span class="linenos">195</span>        <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;System Clock&#39;</span><span class="p">)</span>
<span class="linenos">196</span>        <span class="n">lcd_goto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">197</span>        <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">freq</span><span class="p">()</span><span class="o">/</span><span class="mf">1e6</span><span class="si">}</span><span class="s1">MHz&#39;</span><span class="p">)</span>
<span class="linenos">198</span>        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">199</span>        <span class="n">lcd_home</span><span class="p">()</span>
<span class="linenos">200</span>        <span class="n">lcd_clear</span><span class="p">()</span>
<span class="linenos">201</span>        <span class="n">led_onboard</span><span class="o">.</span><span class="n">toggle</span><span class="p">()</span>
<span class="linenos">202</span>
<span class="linenos">203</span>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">204</span>
<span class="linenos">205</span>        <span class="c1"># read ADC</span>
<span class="linenos">206</span>        <span class="c1"># -----------------------------------------</span>
<span class="linenos">207</span>        <span class="n">adc0_reading</span> <span class="o">=</span> <span class="p">(</span><span class="n">adc0</span><span class="o">.</span><span class="n">read_u16</span><span class="p">()</span> <span class="o">*</span> <span class="n">VOLT_PER_BIT</span><span class="p">)</span>
<span class="linenos">208</span>        <span class="n">adc1_reading</span> <span class="o">=</span> <span class="p">(</span><span class="n">adc1</span><span class="o">.</span><span class="n">read_u16</span><span class="p">()</span> <span class="o">*</span> <span class="n">VOLT_PER_BIT</span><span class="p">)</span>
<span class="linenos">209</span>        <span class="n">lcd_home</span><span class="p">()</span>
<span class="linenos">210</span>        <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ADC0: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">adc0_reading</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">       &#39;</span><span class="p">)</span>
<span class="linenos">211</span>        <span class="n">lcd_goto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">212</span>        <span class="n">lcd_puts</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ADC1: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">adc1_reading</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">       &#39;</span><span class="p">)</span>
<span class="linenos">213</span>        
<span class="linenos">214</span>        <span class="c1"># toggle onboard LED for System speed status and refresh delay</span>
<span class="linenos">215</span>        <span class="c1"># -----------------------------------------</span>
<span class="linenos">216</span>        <span class="n">led_onboard</span><span class="o">.</span><span class="n">toggle</span><span class="p">()</span>
<span class="linenos">217</span>        <span class="n">utime</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="n">REFRESH_PERIOD</span><span class="p">)</span>
<span class="linenos">218</span>        <span class="c1"># gc.collect()</span>
<span class="linenos">219</span>
<span class="linenos">220</span>
<span class="linenos">221</span>
<span class="linenos">222</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline"></a></h2>
<dl class="footnote brackets">
<dt class="label" id="id10"><span class="brackets">2</span></dt>
<dd><p>“What is a bypass capacitor? tutorial: Applications,” Electronics Hub, 14-Sep-2021.
[Online]. Available: <a class="reference external" href="https://www.electronicshub.org/bypass-capacitor-tutorial/">https://www.electronicshub.org/bypass-capacitor-tutorial/</a>. [Accessed:
27-Aug-2022].</p>
</dd>
<dt class="label" id="id11"><span class="brackets">10</span></dt>
<dd><p>“Ltc1661 – micropower dual 10-bit DAC in MSOP - Analog Devices.” [Online]. Available:
<a class="reference external" href="https://www.analog.com/media/en/technical-documentation/data-sheets/1661fb.pdf">https://www.analog.com/media/en/technical-documentation/data-sheets/1661fb.pdf</a>.
[Accessed: 17-Oct-2022].</p>
</dd>
<dt class="label" id="id12"><span class="brackets">13</span><span class="fn-backref">(<a href="#id3">1</a>,<a href="#id4">2</a>,<a href="#id5">3</a>,<a href="#id6">4</a>)</span></dt>
<dd><p>“Raspberry Pico Datasheet,” raspberrypi.com. [Online]. Available:
<a class="reference external" href="https://datasheets.raspberrypi.com/pico/pico-datasheet.pdf">https://datasheets.raspberrypi.com/pico/pico-datasheet.pdf</a>. [Accessed: 15-Nov-2022].</p>
</dd>
<dt class="label" id="id13"><span class="brackets">14</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id7">2</a>)</span></dt>
<dd><p>“Raspberry Pico python SDK,” raspberrypi.com. [Online]. Available:
<a class="reference external" href="https://datasheets.raspberrypi.com/pico/raspberry-pi-pico-python-sdk.pdf">https://datasheets.raspberrypi.com/pico/raspberry-pi-pico-python-sdk.pdf</a>. [Accessed: 15-
Nov-2022].</p>
</dd>
<dt class="label" id="id14"><span class="brackets"><a class="fn-backref" href="#id1">15</a></span></dt>
<dd><p>“RP2040 Datasheet,” raspberrypi.com. [Online]. Available:
<a class="reference external" href="https://datasheets.raspberrypi.com/rp2040/rp2040-datasheet.pdf">https://datasheets.raspberrypi.com/rp2040/rp2040-datasheet.pdf</a>. [Accessed: 14-Nov-2022].</p>
</dd>
<dt class="label" id="id15"><span class="brackets"><a class="fn-backref" href="#id9">16</a></span></dt>
<dd><p>“Serial peripheral interface,” Wikipedia, 27-Sep-2022. [Online]. Available:
<a class="reference external" href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface">https://en.wikipedia.org/wiki/Serial_Peripheral_Interface</a>. [Accessed: 19-Oct-2022].</p>
</dd>
<dt class="label" id="id16"><span class="brackets">17</span></dt>
<dd><p>“Sitronix ST7066U - Crystalfontz,” crystalfontz. [Online]. Available:
<a class="reference external" href="https://www.crystalfontz.com/controllers/Sitronix/ST7066U/438">https://www.crystalfontz.com/controllers/Sitronix/ST7066U/438</a>. [Accessed: 03-Oct2022].</p>
</dd>
<dt class="label" id="id17"><span class="brackets">18</span></dt>
<dd><p>“What is a Bypass Capacitor?,” What is a bypass capacitor? [Online]. Available:
<a class="reference external" href="http://www.learningaboutelectronics.com/Articles/What-is-a-bypass-capacitor.html">http://www.learningaboutelectronics.com/Articles/What-is-a-bypass-capacitor.html</a>.
[Accessed: 27-Aug-2022].</p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ultrasonic_theremin.html" class="btn btn-neutral float-left" title="Ultrasonic Theremin - Junior Design" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="linear_power_supply.html" class="btn btn-neutral float-right" title="Linear Power Supply" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Dieter Steinhauser.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>